<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Auvo Tickets ‚Äî Central de Chamados</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGO ‚Äî EDITE AQUI FACILMENTE
     Op√ß√£o A: texto puro    ‚Üí edite --logo-text abaixo
     Op√ß√£o B: imagem        ‚Üí descomente o <img class="logo-img"> no HTML
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  :root {
    --brand:       #6f2da8;
    --brand-dark:  #5a2090;
    --brand-light: #8b4bc8;
    --brand-xlt:   #f0e8fa;
    --bg:       #f2f3f7;
    --surface:  #ffffff;
    --s2:       #f7f8fb;
    --s3:       #eef0f4;
    --border:   #e2e6ed;
    --red:     #e53935; --red-d:   rgba(229,57,53,.10); --red-g: rgba(229,57,53,.28);
    --amber:   #f59c00; --amber-d: rgba(245,156,0,.12);
    --green:   #1e9e5b; --green-d: rgba(30,158,91,.10);
    --blue:    #2563eb; --blue-d:  rgba(37,99,235,.10);
    --text:      #171b24;
    --text-dim:  #4b5563;
    --text-muted:#6b7280;
    --sh-sm: 0 1px 3px rgba(0,0,0,.07);
    --sh-md: 0 4px 14px rgba(0,0,0,.09);
    --sh-lg: 0 8px 30px rgba(0,0,0,.12);
    --sh-xl: 0 20px 60px rgba(0,0,0,.18);
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  html{scroll-behavior:smooth;}
  body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;-webkit-tap-highlight-color:transparent;}

  /* ‚ïê‚ïê HEADER ‚ïê‚ïê */
  header{position:sticky;top:0;z-index:200;background:var(--brand);height:56px;padding:0 1.25rem;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:0 2px 10px rgba(111,45,168,.4);}
  .logo{display:flex;align-items:center;gap:9px;font-weight:800;font-size:.95rem;letter-spacing:.04em;color:#fff;white-space:nowrap;flex-shrink:0;text-decoration:none;}
  .logo-icon{width:30px;height:30px;background:rgba(255,255,255,.18);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;}
  /* Para usar imagem: adicione display:block no <img class="logo-img"> */
  .logo-img{height:30px;max-width:130px;object-fit:contain;display:none;}
  .header-mid{flex:1;display:flex;align-items:center;justify-content:center;}
  .refresh-bar{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:4px 10px;font-size:.68rem;color:rgba(255,255,255,.9);white-space:nowrap;}
  .live-dot{width:7px;height:7px;border-radius:50%;background:#4ade80;flex-shrink:0;box-shadow:0 0 6px #4ade80;}
  .live-dot.paused{background:rgba(255,255,255,.35);box-shadow:none;}
  .live-dot.syncing{background:#fbbf24;box-shadow:0 0 6px #fbbf24;animation:blink-a .6s ease-in-out infinite;}
  @keyframes blink-a{0%,100%{opacity:1}50%{opacity:.3}}
  .refresh-label{font-weight:700;letter-spacing:.04em;}
  .countdown-wrap{position:relative;width:30px;height:30px;flex-shrink:0;}
  .countdown-wrap svg{transform:rotate(-90deg);}
  .cring-bg{fill:none;stroke:rgba(255,255,255,.18);stroke-width:3;}
  .cring{fill:none;stroke:#c084fc;stroke-width:3;stroke-linecap:round;transition:stroke-dashoffset 1s linear;stroke-dasharray:82;stroke-dashoffset:0;}
  .cring.urgent{stroke:#f87171;}
  .cnum{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.56rem;font-weight:700;color:rgba(255,255,255,.9);}
  .btn-pause{font-family:'Plus Jakarta Sans',sans-serif;font-size:.66rem;font-weight:700;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.22);color:rgba(255,255,255,.9);padding:3px 9px;border-radius:5px;cursor:pointer;transition:all .2s;white-space:nowrap;}
  .btn-pause:hover{background:rgba(255,255,255,.22);}
  .last-upd{font-size:.6rem;color:rgba(255,255,255,.6);white-space:nowrap;}
  .header-right{display:flex;align-items:center;gap:8px;}
  .btn-load{font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:.8rem;background:#fff;color:var(--brand);border:none;padding:6px 16px;border-radius:7px;cursor:pointer;transition:all .2s;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,.12);}
  .btn-load:hover{background:var(--brand-xlt);}
  .btn-load:disabled{opacity:.5;cursor:not-allowed;}

  /* ‚ïê‚ïê TOAST ‚ïê‚ïê */
  .toast{position:fixed;bottom:1.2rem;right:1.2rem;z-index:9999;background:var(--surface);border:1px solid var(--green);color:var(--green);border-radius:10px;padding:10px 16px;font-size:.78rem;font-weight:700;display:flex;align-items:center;gap:8px;box-shadow:var(--sh-lg);transform:translateY(80px);opacity:0;transition:all .4s cubic-bezier(.34,1.56,.64,1);pointer-events:none;max-width:320px;}
  .toast.show{transform:translateY(0);opacity:1;}
  .toast.error{border-color:var(--red);color:var(--red);}
  .toast.info{border-color:var(--blue);color:var(--blue);}

  /* ‚ïê‚ïê MAIN ‚ïê‚ïê */
  main{max-width:1440px;margin:0 auto;padding:1.25rem;}

  /* ‚ïê‚ïê STATS ‚ïê‚ïê */
  .stats-bar{display:grid;grid-template-columns:repeat(5,1fr);gap:.75rem;margin-bottom:1.25rem;opacity:0;transform:translateY(12px);transition:all .4s ease;}
  .stats-bar.visible{opacity:1;transform:none;}
  .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:.9rem 1rem;position:relative;overflow:hidden;box-shadow:var(--sh-sm);}
  .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
  .stat-card.alta::before{background:var(--red);}
  .stat-card.media::before{background:var(--amber);}
  .stat-card.baixa::before{background:var(--green);}
  .stat-card.total::before{background:var(--brand);}
  .stat-card.closed::before{background:#bbb;}
  .stat-label{font-size:.66rem;color:var(--text-muted);letter-spacing:.05em;text-transform:uppercase;font-weight:600;margin-bottom:4px;}
  .stat-value{font-size:1.9rem;font-weight:800;line-height:1;}
  .stat-card.alta .stat-value{color:var(--red);}
  .stat-card.media .stat-value{color:var(--amber);}
  .stat-card.baixa .stat-value{color:var(--green);}
  .stat-card.total .stat-value{color:var(--brand);}
  .stat-card.closed .stat-value{color:#9ca3af;}
  .stat-sub{font-size:.6rem;color:var(--text-muted);margin-top:3px;}

  /* ‚ïê‚ïê TOOLBAR ‚ïê‚ïê */
  .toolbar{display:flex;align-items:center;gap:8px;margin-bottom:1.1rem;flex-wrap:wrap;opacity:0;transition:opacity .4s ease .1s;}
  .toolbar.visible{opacity:1;}
  .filter-btn{font-family:'Plus Jakarta Sans',sans-serif;font-size:.75rem;font-weight:700;padding:5px 14px;border-radius:20px;border:1px solid var(--border);background:var(--surface);color:var(--text-dim);cursor:pointer;transition:all .2s;}
  .filter-btn:hover{border-color:var(--brand);color:var(--brand);}
  .filter-btn.active-all{background:var(--brand);border-color:var(--brand);color:#fff;}
  .filter-btn.active-alta{background:var(--red-d);border-color:var(--red);color:var(--red);}
  .filter-btn.active-media{background:var(--amber-d);border-color:var(--amber);color:var(--amber);}
  .filter-btn.active-baixa{background:var(--green-d);border-color:var(--green);color:var(--green);}
  .toolbar-spacer{flex:1;}
  .view-toggle{display:flex;background:var(--s2);border:1px solid var(--border);border-radius:8px;overflow:hidden;}
  .view-btn{font-family:'Plus Jakarta Sans',sans-serif;font-size:.72rem;font-weight:700;padding:6px 13px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px;}
  .view-btn.active{background:var(--brand);color:#fff;}
  .view-btn:not(.active):hover{background:var(--brand-xlt);color:var(--brand);}

  /* ‚ïê‚ïê GRID VIEW ‚ïê‚ïê */
  .tickets-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:.9rem;}
  .ticket-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1rem;cursor:pointer;transition:all .2s ease;position:relative;overflow:hidden;animation:cardIn .3s ease both;box-shadow:var(--sh-sm);}
  @keyframes cardIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
  .ticket-card:hover{transform:translateY(-2px);box-shadow:var(--sh-md);border-color:var(--brand-light);}
  .ticket-card.prio-alta{border-left:4px solid var(--red);}
  .ticket-card.prio-alta::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--red);}
  .ticket-card.removing{animation:cardOut .4s ease forwards;}
  @keyframes cardOut{to{opacity:0;transform:scale(.9);height:0;margin:0;padding:0;border-width:0;overflow:hidden;}}
  .alert-banner{display:flex;align-items:center;gap:5px;background:var(--red-d);border:1px solid rgba(229,57,53,.25);border-radius:5px;padding:3px 8px;margin-bottom:8px;font-size:.63rem;color:var(--red);font-weight:700;text-transform:uppercase;letter-spacing:.06em;}
  .blink{width:5px;height:5px;background:var(--red);border-radius:50%;animation:blink 1s ease-in-out infinite;flex-shrink:0;}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
  .card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:6px;}
  .ticket-id{font-size:1.1rem;font-weight:800;line-height:1;color:var(--brand);}
  .ticket-id span{font-size:.6rem;color:var(--text-muted);font-weight:600;display:block;margin-bottom:2px;letter-spacing:.08em;text-transform:uppercase;}
  .prio-badge{font-size:.66rem;font-weight:700;letter-spacing:.04em;text-transform:uppercase;padding:2px 9px;border-radius:20px;flex-shrink:0;}
  .prio-badge.alta{background:var(--red-d);color:var(--red);border:1px solid rgba(229,57,53,.3);}
  .prio-badge.media{background:var(--amber-d);color:var(--amber);border:1px solid rgba(245,156,0,.28);}
  .prio-badge.baixa{background:var(--green-d);color:var(--green);border:1px solid rgba(30,158,91,.28);}
  .prio-badge.normal{background:var(--blue-d);color:var(--blue);border:1px solid rgba(37,99,235,.28);}
  .ticket-title{font-size:.82rem;color:var(--text-dim);margin-bottom:10px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
  .assignee-row{display:flex;align-items:center;gap:7px;padding:7px 9px;background:var(--s2);border-radius:7px;margin-bottom:8px;border:1px solid var(--border);}
  .avatar{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand-light));display:flex;align-items:center;justify-content:center;font-size:.62rem;font-weight:700;color:#fff;flex-shrink:0;text-transform:uppercase;}
  .assignee-info{flex:1;min-width:0;}
  .assignee-name{font-size:.76rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600;}
  .assignee-label{font-size:.6rem;color:var(--text-muted);letter-spacing:.04em;text-transform:uppercase;font-weight:600;}
  .card-tasks{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;}
  .task-badge{font-size:.62rem;font-weight:700;padding:2px 8px;border-radius:20px;background:var(--brand-xlt);color:var(--brand);border:1px solid rgba(111,45,168,.2);cursor:pointer;transition:all .15s;white-space:nowrap;}
  .task-badge:hover{background:var(--brand);color:#fff;}
  .card-footer{display:flex;align-items:center;justify-content:space-between;gap:5px;flex-wrap:wrap;}
  .status-chip{font-size:.62rem;padding:2px 8px;border-radius:20px;background:var(--brand-xlt);color:var(--brand);border:1px solid rgba(111,45,168,.18);font-weight:700;}
  .card-date{font-size:.62rem;color:var(--text-muted);font-weight:600;}
  .expand-hint{font-size:.62rem;color:var(--brand);opacity:0;transition:opacity .2s;font-weight:700;}
  .ticket-card:hover .expand-hint{opacity:1;}

  /* ‚ïê‚ïê LIST VIEW ‚ïê‚ïê */
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;border-radius:12px;box-shadow:var(--sh-sm);}
  .tickets-table{width:100%;border-collapse:separate;border-spacing:0;background:var(--surface);border-radius:12px;overflow:hidden;border:1px solid var(--border);}
  .tickets-table thead th{background:var(--s2);padding:.75rem 1rem;text-align:left;font-size:.65rem;font-weight:700;color:var(--text-muted);letter-spacing:.06em;text-transform:uppercase;border-bottom:1px solid var(--border);white-space:nowrap;}
  .tickets-table tbody tr{cursor:pointer;transition:background .15s;}
  .tickets-table tbody tr:not(:last-child) td{border-bottom:1px solid var(--border);}
  .tickets-table tbody tr:hover td{background:var(--s2);}
  .tickets-table td{padding:.7rem 1rem;font-size:.8rem;vertical-align:middle;}
  .table-id{font-weight:800;color:var(--brand);white-space:nowrap;}
  .table-title{color:var(--text-dim);max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .table-client{color:var(--text-dim);max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-weight:500;}
  .table-assignee{white-space:nowrap;color:var(--text);font-weight:600;}
  .table-date{white-space:nowrap;color:var(--text-muted);font-size:.72rem;}
  .table-tasks{display:flex;flex-wrap:wrap;gap:3px;}
  .trow-alta td:first-child{border-left:3px solid var(--red);}
  .trow-media td:first-child{border-left:3px solid var(--amber);}
  .trow-baixa td:first-child{border-left:3px solid var(--green);}

  /* ‚ïê‚ïê KANBAN VIEW ‚ïê‚ïê */
  .kanban-board{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;align-items:start;}
  .kanban-col{background:var(--s2);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
  .kanban-header{padding:.85rem 1rem;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);}
  .kanban-header.alta{border-top:3px solid var(--red);}
  .kanban-header.media{border-top:3px solid var(--amber);}
  .kanban-header.baixa{border-top:3px solid var(--green);}
  .kanban-col-title{font-size:.78rem;font-weight:800;letter-spacing:.04em;text-transform:uppercase;}
  .kanban-col.alta .kanban-col-title{color:var(--red);}
  .kanban-col.media .kanban-col-title{color:var(--amber);}
  .kanban-col.baixa .kanban-col-title{color:var(--green);}
  .kanban-count{margin-left:auto;font-size:.68rem;font-weight:700;padding:2px 8px;border-radius:20px;}
  .kanban-col.alta .kanban-count{background:var(--red-d);color:var(--red);}
  .kanban-col.media .kanban-count{background:var(--amber-d);color:var(--amber);}
  .kanban-col.baixa .kanban-count{background:var(--green-d);color:var(--green);}
  .kanban-cards{padding:.7rem;display:flex;flex-direction:column;gap:.55rem;min-height:60px;}
  .kanban-card{background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:.8rem;cursor:pointer;transition:all .2s;box-shadow:var(--sh-sm);animation:cardIn .3s ease both;}
  .kanban-card:hover{transform:translateY(-2px);box-shadow:var(--sh-md);border-color:var(--brand-light);}
  .kcard-id{font-size:.7rem;font-weight:800;color:var(--brand);margin-bottom:3px;}
  .kcard-title{font-size:.79rem;color:var(--text-dim);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:7px;}
  .kcard-tasks{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px;}
  .kcard-footer{display:flex;align-items:center;justify-content:space-between;gap:5px;}
  .kcard-assignee{display:flex;align-items:center;gap:5px;font-size:.68rem;color:var(--text-muted);font-weight:600;}
  .kcard-av{width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand-light));display:flex;align-items:center;justify-content:center;font-size:.54rem;font-weight:700;color:#fff;flex-shrink:0;text-transform:uppercase;}
  .kcard-date{font-size:.62rem;color:var(--text-muted);}

  /* ‚ïê‚ïê MODAIS BASE ‚ïê‚ïê */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;pointer-events:none;transition:opacity .25s;}
  .modal-overlay.open{opacity:1;pointer-events:all;}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:660px;max-height:90vh;overflow-y:auto;transform:scale(.95) translateY(14px);transition:transform .3s cubic-bezier(.34,1.56,.64,1);box-shadow:var(--sh-xl);}
  .modal-overlay.open .modal{transform:none;}
  .modal.prio-alta{border-top:4px solid var(--red);}
  .modal-header{padding:1.25rem 1.25rem .9rem;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:1;border-radius:16px 16px 0 0;}
  .modal-top{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:6px;}
  .modal-id{font-size:1.6rem;font-weight:800;line-height:1;color:var(--brand);}
  .modal-id small{font-size:.68rem;font-weight:600;color:var(--text-muted);display:block;margin-bottom:2px;letter-spacing:.08em;text-transform:uppercase;}
  .modal-close{width:30px;height:30px;background:var(--s2);border:1px solid var(--border);border-radius:50%;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;transition:all .2s;}
  .modal-close:hover{background:var(--brand-xlt);color:var(--brand);}
  .modal-title{font-size:.9rem;color:var(--text-dim);line-height:1.5;font-weight:500;}
  .modal-body{padding:1.25rem;}
  .modal-alert{background:var(--red-d);border:1px solid rgba(229,57,53,.25);border-radius:9px;padding:9px 12px;display:flex;align-items:center;gap:8px;margin-bottom:1.25rem;color:var(--red);font-size:.8rem;font-weight:700;}
  .modal-section{margin-bottom:1.25rem;}
  .section-label{font-size:.65rem;color:var(--brand);letter-spacing:.1em;text-transform:uppercase;font-weight:800;margin-bottom:8px;padding-bottom:5px;border-bottom:2px solid var(--brand-xlt);}
  .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  .info-item{background:var(--s2);border-radius:7px;padding:9px 11px;border:1px solid var(--border);}
  .info-item.full{grid-column:1/-1;}
  .info-key{font-size:.62rem;color:var(--text-muted);letter-spacing:.07em;text-transform:uppercase;font-weight:700;margin-bottom:3px;}
  .info-val{font-size:.82rem;color:var(--text);word-break:break-word;font-weight:500;}
  .info-val.highlight{font-weight:800;font-size:.9rem;}
  .info-val.alta{color:var(--red);}.info-val.media{color:var(--amber);}.info-val.baixa{color:var(--green);}
  .dates-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
  .date-card{background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:10px;text-align:center;}
  .date-icon{font-size:1.1rem;margin-bottom:4px;}
  .date-label{font-size:.6rem;color:var(--text-muted);letter-spacing:.08em;text-transform:uppercase;font-weight:700;margin-bottom:3px;}
  .date-value{font-size:.8rem;font-weight:800;color:var(--text);}
  .date-time{font-size:.63rem;color:var(--text-muted);margin-top:2px;}
  .desc-box{background:var(--s2);border:1px solid var(--border);border-radius:7px;padding:10px 12px;font-size:.8rem;color:var(--text-dim);line-height:1.6;max-height:110px;overflow-y:auto;}
  /* Tasks no modal */
  .modal-tasks{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
  .modal-task-badge{font-size:.76rem;font-weight:700;padding:4px 12px;border-radius:20px;background:var(--brand-xlt);color:var(--brand);border:1px solid rgba(111,45,168,.2);}

  /* ‚ïê‚ïê BTN CRIAR TAREFA ‚ïê‚ïê */
  .btn-create-task{width:100%;margin-top:.4rem;font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:.83rem;background:var(--brand);border:none;color:#fff;padding:11px 18px;border-radius:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s;box-shadow:0 4px 12px rgba(111,45,168,.28);}
  .btn-create-task:hover{background:var(--brand-dark);box-shadow:0 6px 18px rgba(111,45,168,.38);}

  /* ‚ïê‚ïê MODAL CRIAR TAREFA ‚ïê‚ïê */
  .task-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(5px);z-index:2000;display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;pointer-events:none;transition:opacity .25s;}
  .task-modal-overlay.open{opacity:1;pointer-events:all;}
  .task-modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:600px;max-height:92vh;overflow-y:auto;transform:scale(.95) translateY(18px);transition:transform .35s cubic-bezier(.34,1.56,.64,1);box-shadow:var(--sh-xl);}
  .task-modal-overlay.open .task-modal{transform:none;}
  .task-modal-header{padding:1.25rem 1.25rem .9rem;background:linear-gradient(135deg,var(--brand),var(--brand-light));border-radius:16px 16px 0 0;position:sticky;top:0;z-index:1;}
  .task-modal-top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:5px;}
  .task-modal-title{font-size:1rem;font-weight:800;color:#fff;display:flex;align-items:center;gap:7px;}
  .task-modal-sub{font-size:.72rem;color:rgba(255,255,255,.75);font-weight:600;}
  .origin-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.28);border-radius:5px;padding:3px 9px;font-size:.68rem;color:#fff;margin-top:5px;font-weight:600;}
  .prio-inherited{display:flex;align-items:center;gap:7px;background:var(--s2);border:1px solid var(--border);border-radius:7px;padding:9px 12px;margin-bottom:1rem;font-size:.8rem;color:var(--text-dim);font-weight:500;}
  .prio-inherited strong{font-weight:800;font-size:.86rem;}
  .prio-inherited.prio-alta strong{color:var(--red);}
  .prio-inherited.prio-media strong{color:var(--amber);}
  .prio-inherited.prio-baixa strong{color:var(--green);}
  .prio-lock{font-size:.65rem;color:var(--text-muted);margin-left:auto;display:flex;align-items:center;gap:3px;}
  .task-form{padding:1.25rem 1.25rem .75rem;}
  .form-group{margin-bottom:1rem;}
  .form-label{font-size:.7rem;color:var(--text-muted);letter-spacing:.06em;text-transform:uppercase;font-weight:700;margin-bottom:5px;display:flex;align-items:center;gap:4px;}
  .form-label .req{color:var(--red);}
  .form-label .lbl-hint{color:var(--brand);font-size:.63rem;margin-left:auto;letter-spacing:0;font-weight:600;}
  .form-input,.form-select,.form-textarea{width:100%;background:var(--s2);border:1px solid var(--border);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.83rem;font-weight:500;padding:9px 11px;border-radius:7px;outline:none;transition:border-color .2s,box-shadow .2s;appearance:none;}
  .form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(111,45,168,.08);}
  .form-input::placeholder,.form-textarea::placeholder{color:var(--text-muted);}
  .form-select{cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 11px center;padding-right:30px;}
  .form-textarea{resize:vertical;min-height:85px;line-height:1.5;}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .select-loading{position:relative;}
  .select-loading::after{content:'';position:absolute;right:34px;top:50%;transform:translateY(-50%);width:13px;height:13px;border:2px solid var(--border);border-top-color:var(--brand);border-radius:50%;animation:spin .7s linear infinite;}
  @keyframes spin{to{transform:translateY(-50%) rotate(360deg)}}
  .select-error-note{font-size:.68rem;color:var(--amber);margin-top:3px;display:none;font-weight:600;}
  .task-form-footer{display:flex;gap:8px;padding:0 1.25rem 1.25rem;justify-content:flex-end;}
  .btn-cancel-task{font-family:'Plus Jakarta Sans',sans-serif;font-size:.8rem;font-weight:700;background:transparent;border:1px solid var(--border);color:var(--text-muted);padding:9px 18px;border-radius:7px;cursor:pointer;transition:all .2s;}
  .btn-cancel-task:hover{border-color:var(--brand);color:var(--brand);}
  .btn-submit-task{font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:.83rem;background:var(--brand);color:#fff;border:none;padding:9px 26px;border-radius:7px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:7px;box-shadow:0 4px 12px rgba(111,45,168,.28);}
  .btn-submit-task:hover{background:var(--brand-dark);}
  .btn-submit-task:disabled{opacity:.5;cursor:not-allowed;}
  .form-divider{height:1px;background:var(--border);margin:1rem 0;}
  .spinner{width:38px;height:38px;border:2px solid var(--border);border-top-color:var(--brand);border-radius:50%;animation:spin2 .8s linear infinite;}
  @keyframes spin2{to{transform:rotate(360deg)}}
  .spinner-sm{width:14px;height:14px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin2 .7s linear infinite;display:none;}
  .btn-submit-task.loading .spinner-sm{display:block;}
  .btn-submit-task.loading .btn-label{display:none;}
  .state-box{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4rem 2rem;color:var(--text-muted);text-align:center;gap:.9rem;}
  .state-box .icon{font-size:2.8rem;opacity:.3;}
  .state-box p{font-size:.85rem;line-height:1.6;max-width:340px;font-weight:500;}
  .error-box{background:var(--red-d);border:1px solid rgba(229,57,53,.28);border-radius:9px;padding:.9rem 1.1rem;color:var(--red);font-size:.83rem;font-weight:600;margin-bottom:.9rem;display:none;}

  /* ‚ïê‚ïê SCROLLBAR ‚ïê‚ïê */
  ::-webkit-scrollbar{width:5px;height:5px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
  ::-webkit-scrollbar-thumb:hover{background:var(--brand-light);}

  /* ‚ïê‚ïê RESPONSIVE ‚ïê‚ïê */
  @media(max-width:1024px){
    .stats-bar{grid-template-columns:repeat(3,1fr);}
    .stat-card.closed{display:none;}
  }
  @media(max-width:768px){
    header{height:52px;padding:0 1rem;}
    .header-mid{display:none;}
    .logo{font-size:.85rem;}
    main{padding:.85rem .75rem;}
    .stats-bar{grid-template-columns:repeat(2,1fr);gap:.55rem;margin-bottom:.9rem;}
    .stat-card.closed,.stat-card.total{display:none;}
    .stat-value{font-size:1.6rem;}
    .toolbar{gap:5px;margin-bottom:.85rem;}
    .filter-btn{font-size:.7rem;padding:4px 10px;}
    .view-btn span{display:none;}
    .view-btn{padding:6px 10px;}
    .tickets-grid{grid-template-columns:1fr;}
    .kanban-board{grid-template-columns:1fr;gap:.7rem;}
    .info-grid,.dates-grid,.form-row{grid-template-columns:1fr;}
    .modal-overlay,.task-modal-overlay{padding:.5rem;align-items:flex-end;}
    .modal,.task-modal{border-radius:16px 16px 0 0;max-height:92vh;}
    .tickets-table thead th:nth-child(n+5){display:none;}
    .tickets-table td:nth-child(n+5){display:none;}
  }
  @media(max-width:480px){
    .stats-bar{grid-template-columns:repeat(2,1fr);}
    .toolbar{gap:4px;}
  }
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
<header>
  <!--
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  LOGO ‚Äî como alterar:                                ‚îÇ
    ‚îÇ  TEXTO: edite o conte√∫do do <span> abaixo           ‚îÇ
    ‚îÇ  √çCONE: troque o emoji dentro de .logo-icon          ‚îÇ
    ‚îÇ  IMAGEM: descomente a linha <img class="logo-img">   ‚îÇ
    ‚îÇ          e apague a .logo-text-wrap                  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  -->
  <a class="logo" href="#">
    <div class="logo-icon">üé´</div>
    <span>AUVO TICKETS</span>
    <!-- Para imagem: <img class="logo-img" src="logo.png" alt="Logo" style="display:block"> -->
  </a>

  <div class="header-mid">
    <div class="refresh-bar" id="refresh-bar" style="display:none;">
      <div class="live-dot" id="live-dot"></div>
      <span class="refresh-label" id="refresh-label">AO VIVO</span>
      <div class="countdown-wrap">
        <svg width="30" height="30" viewBox="0 0 30 30">
          <circle class="cring-bg" cx="15" cy="15" r="13"/>
          <circle class="cring" id="cring" cx="15" cy="15" r="13"/>
        </svg>
        <div class="cnum" id="cnum">10m</div>
      </div>
      <button class="btn-pause" id="btn-pause" onclick="togglePause()">‚è∏ PAUSAR</button>
      <span class="last-upd" id="last-upd"></span>
    </div>
  </div>

  <div class="header-right">
    <button class="btn-load" id="btn-load" onclick="startSession()">‚ñ∂ CARREGAR</button>
  </div>
</header>

<main>
  <div class="error-box" id="error-box"></div>

  <div class="stats-bar" id="stats-bar">
    <div class="stat-card alta"><div class="stat-label">‚ö† Alta</div><div class="stat-value" id="stat-alta">0</div></div>
    <div class="stat-card media"><div class="stat-label">M√©dia</div><div class="stat-value" id="stat-media">0</div></div>
    <div class="stat-card baixa"><div class="stat-label">Baixa</div><div class="stat-value" id="stat-baixa">0</div></div>
    <div class="stat-card total"><div class="stat-label">Em Aberto</div><div class="stat-value" id="stat-total">0</div></div>
    <div class="stat-card closed"><div class="stat-label">Finalizados</div><div class="stat-value" id="stat-closed">0</div><div class="stat-sub">ocultos no painel</div></div>
  </div>

  <div class="toolbar" id="toolbar">
    <button class="filter-btn active-all" onclick="filterTickets('all',this)">Todos</button>
    <button class="filter-btn" onclick="filterTickets('alta',this)">üî¥ Alta</button>
    <button class="filter-btn" onclick="filterTickets('media',this)">üü° M√©dia</button>
    <button class="filter-btn" onclick="filterTickets('baixa',this)">üü¢ Baixa</button>
    <div class="toolbar-spacer"></div>
    <div class="view-toggle">
      <button class="view-btn active" id="vbtn-grid" onclick="setView('grid')" title="Cards">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        <span>Cards</span>
      </button>
      <button class="view-btn" id="vbtn-list" onclick="setView('list')" title="Lista">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        <span>Lista</span>
      </button>
      <button class="view-btn" id="vbtn-kanban" onclick="setView('kanban')" title="Kanban">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="5" height="18" rx="1"/><rect x="10" y="3" width="5" height="13" rx="1"/><rect x="17" y="3" width="5" height="16" rx="1"/></svg>
        <span>Kanban</span>
      </button>
    </div>
  </div>

  <div id="tickets-container">
    <div class="state-box"><div class="icon">üé´</div><p>Clique em <strong>Carregar</strong> para iniciar o monitoramento de tickets.</p></div>
  </div>
</main>

<!-- ‚ïê‚ïê MODAL TICKET ‚ïê‚ïê -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <div class="modal-header">
      <div class="modal-top">
        <div class="modal-id" id="modal-id"><small>TICKET</small>#‚Äî</div>
        <button class="modal-close" onclick="closeModalDirect()">‚úï</button>
      </div>
      <div class="modal-title" id="modal-title"></div>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<!-- ‚ïê‚ïê MODAL DETALHE TAREFA ‚ïê‚ïê -->
<div class="modal-overlay" id="task-detail-overlay" onclick="if(event.target===this)closeTaskDetail()" style="z-index:3000;">
  <div class="modal" id="task-detail-modal" style="max-width:620px;">
    <div class="modal-header">
      <div class="modal-top">
        <div class="modal-id" id="td-id"><small>TAREFA</small>#‚Äî</div>
        <button class="modal-close" onclick="closeTaskDetail()">‚úï</button>
      </div>
      <div class="modal-title" id="td-title" style="font-size:.82rem;color:var(--text-muted);"></div>
    </div>
    <div class="modal-body" id="td-body">
      <div style="display:flex;align-items:center;justify-content:center;padding:3rem;"><div class="spinner"></div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê MODAL CRIAR TAREFA ‚ïê‚ïê -->
<div class="task-modal-overlay" id="task-modal-overlay" onclick="closeTaskModal(event)">
  <div class="task-modal" id="task-modal">
    <div class="task-modal-header">
      <div class="task-modal-top">
        <div class="task-modal-title">
          <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="15" x2="12" y2="15"/></svg>
          CRIAR TAREFA
        </div>
        <button class="modal-close" onclick="closeTaskModalDirect()" style="background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.3);color:#fff;">‚úï</button>
      </div>
      <div class="task-modal-sub" id="task-modal-sub">Vinculada ao Ticket #‚Äî</div>
      <div class="origin-badge" id="task-origin-badge">üé´ Ticket #‚Äî</div>
    </div>
    <div class="task-form">
      <div class="prio-inherited" id="prio-inherited-box">
        <span>Prioridade herdada:</span>
        <strong id="prio-inherited-label">‚Äî</strong>
        <span class="prio-lock">üîí autom√°tico</span>
      </div>
      <div class="form-group">
        <div class="form-label">T√≠tulo <span class="req">*</span></div>
        <input class="form-input" id="task-titulo" type="text" placeholder="Ex: Verificar equipamento no local"/>
      </div>
      <div class="form-group">
        <div class="form-label">Colaborador respons√°vel <span class="req">*</span><span class="lbl-hint" id="users-hint"></span></div>
        <div class="select-loading" id="users-loading-wrap">
          <select class="form-select" id="task-colaborador" disabled><option value="">Carregando...</option></select>
        </div>
        <div class="select-error-note" id="users-error">‚ö† Falha. <a href="#" onclick="loadUsers()" style="color:var(--amber)">Tentar novamente</a></div>
      </div>
      <div class="form-group">
        <div class="form-label">Tipos de Tarefas <span class="req">*</span><span class="lbl-hint" id="types-hint"></span></div>
        <div class="select-loading" id="types-loading-wrap">
          <select class="form-select" id="task-tipo" disabled><option value="">Carregando...</option></select>
        </div>
        <div class="select-error-note" id="types-error">‚ö† Falha. <a href="#" onclick="loadTaskTypes()" style="color:var(--amber)">Tentar novamente</a></div>
      </div>
      <div class="form-row">
        <div class="form-group" style="margin-bottom:0;">
          <div class="form-label">Data agendada <span class="req">*</span></div>
          <input class="form-input" id="task-data" type="datetime-local"/>
        </div>
        <div class="form-group" style="margin-bottom:0;">
          <div class="form-label">Colaborador para execu√ß√£o</div>
          <div id="task-colaborador-display" style="display:flex;align-items:center;gap:8px;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;min-height:40px;">
            <div id="task-colab-avatar" class="avatar" style="width:26px;height:26px;font-size:.62rem;flex-shrink:0;">?</div>
            <span id="task-colab-nome" style="font-size:.82rem;color:var(--text-muted);font-weight:500;">Selecione um colaborador</span>
          </div>
        </div>
      </div>
      <div class="form-divider"></div>
      <div class="form-group">
        <div class="form-label">Descri√ß√£o do Cliente <span class="req">*</span></div>
        <textarea class="form-textarea" id="task-descricao" placeholder="Descreva o que deve ser feito nesta tarefa..."></textarea>
      </div>
      <div class="form-group">
        <div class="form-label">Orienta√ß√£o ao colaborador</div>
        <textarea class="form-textarea" id="task-orientacao" placeholder="Instru√ß√µes espec√≠ficas para o t√©cnico..." style="min-height:65px;"></textarea>
      </div>
    </div>
    <div class="task-form-footer">
      <button class="btn-cancel-task" onclick="closeTaskModalDirect()">Cancelar</button>
      <button class="btn-submit-task" id="btn-submit-task" onclick="submitTask()">
        <span class="btn-label">‚úì CRIAR TAREFA</span>
        <div class="spinner-sm"></div>
      </button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BASE_API   = 'https://auvo-tickets-backend-production.up.railway.app';
const REFRESH_MS = 10 * 60 * 1000;
const RING_CIRC  = 2 * Math.PI * 13;
const CLOSED_STATUS_TYPES = [4,5];
const CLOSED_STATUS_WORDS = ['encerrado','encerrada','cancelado','cancelada','conclu√≠do','concluida','finalizado','finalizada','closed','done'];

let allTickets    = [];
let closedCount   = 0;
let currentFilter = 'all';
let countdownTimer= null;
let isPaused      = false;
let secondsLeft   = REFRESH_MS/1000;
let currentTicket = null;
let currentView   = 'grid';
// taskIDs criadas localmente nesta sess√£o { ticketId ‚Üí [taskId,...] }
let localTaskMap  = {};
let localTaskColaborador = {};
let cachedUsers     = null;
let cachedTaskTypes = null;

// ‚ïê‚ïê SESSION ‚ïê‚ïê
async function startSession() {
  stopTimers(); setLoading(true); hideError();
  try {
    await refreshData(true);
    startAutoRefresh(); showRefreshBar();
    loadUsers(true); loadTaskTypes(true);
  } catch(err) { handleFetchError(err); }
  finally { setLoading(false); }
}

// ‚ïê‚ïê FETCH ‚ïê‚ïê
async function fetchAllTickets() {
  const res = await fetch(`${BASE_API}/api/tickets`);
  if (!res.ok) { const e=await res.json().catch(()=>({})); throw new Error(e.error||`Erro ${res.status}`); }
  const data = await res.json();
  return data?.result?.entityList || [];
}

// ‚ïê‚ïê COLLABORATORS ‚ïê‚ïê
async function loadUsers(silent=false) {
  if (cachedUsers) { populateUsersSelect(cachedUsers); return; }
  const wrap=document.getElementById('users-loading-wrap');
  const sel=document.getElementById('task-colaborador');
  const err=document.getElementById('users-error');
  wrap.classList.add('select-loading'); err.style.display='none'; sel.disabled=true;
  try {
    const res=await fetch(`${BASE_API}/api/collaborators`);
    const data=await res.json();
    if (!res.ok) throw new Error(data.error||`Erro ${res.status}`);
    const list=data?.result?.entityList||[];
    if (!list.length) throw new Error('Nenhum colaborador retornado.');
    cachedUsers=list.filter(u=>u.active!==false&&!u.unavailableForTasks);
    if (!cachedUsers.length) cachedUsers=list;
    populateUsersSelect(cachedUsers);
    if (!silent) document.getElementById('users-hint').textContent=`${cachedUsers.length} colaboradores`;
  } catch(e) {
    sel.innerHTML=`<option value="">‚ö† ${e.message}</option>`; sel.disabled=false; err.style.display='block';
  } finally { wrap.classList.remove('select-loading'); }
}

function populateUsersSelect(users) {
  const sel=document.getElementById('task-colaborador'), hint=document.getElementById('users-hint');
  sel.innerHTML='<option value="">Selecione um colaborador</option>';
  [...users].sort((a,b)=>(a.name||'').localeCompare(b.name||'','pt-BR')).forEach(u=>{
    const opt=document.createElement('option');
    opt.value=u.userID||u.userId||u.collaboratorId||u.id||'';
    opt.textContent=(u.name||`#${opt.value}`)+(u.jobPosition?` (${u.jobPosition})`:'');
    sel.appendChild(opt);
  });
  sel.disabled=false; hint.textContent=`${users.length} colaboradores`;
  sel.onchange=function(){
    const nome=this.options[this.selectedIndex]?.text||'';
    const nomeDisp=(nome==='Selecione um colaborador'||!this.value)?'':nome;
    const av=document.getElementById('task-colab-avatar');
    const nm=document.getElementById('task-colab-nome');
    if(av&&nm){
      av.textContent=nomeDisp?nomeDisp.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase():'?';
      nm.textContent=nomeDisp||'Selecione um colaborador';
      nm.style.color=nomeDisp?'var(--text)':'var(--text-muted)';
    }
  };
}

// ‚ïê‚ïê TASK TYPES ‚ïê‚ïê
async function loadTaskTypes(silent=false) {
  if (cachedTaskTypes) { populateTaskTypesSelect(cachedTaskTypes); return; }
  const wrap=document.getElementById('types-loading-wrap');
  const sel=document.getElementById('task-tipo');
  const err=document.getElementById('types-error');
  wrap.classList.add('select-loading'); err.style.display='none'; sel.disabled=true;
  try {
    const res=await fetch(`${BASE_API}/api/task-types`);
    const data=await res.json();
    if (!res.ok) throw new Error(data.error||`Erro ${res.status}`);
    const list=data?.result?.entityList||[];
    if (!list.length) throw new Error('Nenhum tipo retornado.');
    cachedTaskTypes=list;
    populateTaskTypesSelect(cachedTaskTypes);
    if (!silent) document.getElementById('types-hint').textContent=`${list.length} tipos`;
  } catch(e) {
    sel.innerHTML=`<option value="">‚ö† ${e.message}</option>`; sel.disabled=false; err.style.display='block';
  } finally { wrap.classList.remove('select-loading'); }
}

function populateTaskTypesSelect(types) {
  const sel=document.getElementById('task-tipo'), hint=document.getElementById('types-hint');
  sel.innerHTML='<option value="">Selecione o tipo</option>';
  [...types].sort((a,b)=>(a.description||'').localeCompare(b.description||'','pt-BR')).forEach(tp=>{
    const opt=document.createElement('option');
    opt.value=tp.id||'';
    opt.textContent=tp.description||`#${opt.value}`;
    sel.appendChild(opt);
  });
  sel.disabled=false; hint.textContent=`${types.length} tipos`;
}

// ‚ïê‚ïê AUTO REFRESH ‚ïê‚ïê
function isFinished(t) {
  if (CLOSED_STATUS_TYPES.includes(t.statusType)) return true;
  const d=(t.statusDescription||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  return CLOSED_STATUS_WORDS.some(w=>d.includes(w));
}
async function refreshData(isInitial=false) {
  setSyncingDot(true);
  try {
    const all=await fetchAllTickets();
    const open=all.filter(t=>!isFinished(t));
    const closed=all.filter(t=>isFinished(t));
    if (!isInitial && allTickets.length>0) detectChanges(allTickets,open);
    allTickets=open; closedCount=closed.length;
    renderAll(open,closed.length); updateLastUpdate();
  } catch(err) { console.error(err); showToast('‚ö† Falha ao atualizar.','error'); }
  finally { setSyncingDot(false); }
}
function detectChanges(prev,next){
  const pIds=new Set(prev.map(t=>t.id)),nIds=new Set(next.map(t=>t.id));
  prev.filter(t=>!nIds.has(t.id)).forEach(t=>{const c=document.querySelector(`[data-ticket-id="${t.id}"]`);if(c){c.classList.add('removing');setTimeout(()=>c.remove(),400);}});
  const added=next.filter(t=>!pIds.has(t.id));
  if (added.length) showToast(`+ ${added.length} novo(s) ticket(s).`,'info');
}
function startAutoRefresh(){
  stopTimers(); secondsLeft=REFRESH_MS/1000; updateCountdownUI();
  countdownTimer=setInterval(()=>{if(isPaused)return;secondsLeft--;updateCountdownUI();if(secondsLeft<=0){secondsLeft=REFRESH_MS/1000;refreshData(false);}},1000);
}
function stopTimers(){clearInterval(countdownTimer);}
function togglePause(){
  isPaused=!isPaused;
  const btn=document.getElementById('btn-pause'),dot=document.getElementById('live-dot'),lbl=document.getElementById('refresh-label');
  if(isPaused){btn.textContent='‚ñ∂ RETOMAR';dot.classList.add('paused');lbl.textContent='PAUSADO';}
  else{btn.textContent='‚è∏ PAUSAR';dot.classList.remove('paused');lbl.textContent='AO VIVO';secondsLeft=REFRESH_MS/1000;}
}
function updateCountdownUI(){
  const ring=document.getElementById('cring'),num=document.getElementById('cnum');
  if(!ring)return;
  const pct=secondsLeft/(REFRESH_MS/1000),offset=RING_CIRC-(RING_CIRC*pct);
  ring.style.strokeDasharray=RING_CIRC;ring.style.strokeDashoffset=offset;
  ring.classList.toggle('urgent',secondsLeft<=60);
  num.textContent=secondsLeft<=60?secondsLeft+'s':Math.ceil(secondsLeft/60)+'m';
}
function setSyncingDot(on){
  const dot=document.getElementById('live-dot'),lbl=document.getElementById('refresh-label');
  if(!dot)return;
  if(on){dot.classList.add('syncing');lbl.textContent='SINCRONIZANDO...';}
  else{dot.classList.remove('syncing');dot.className='live-dot'+(isPaused?' paused':'');lbl.textContent=isPaused?'PAUSADO':'AO VIVO';}
}
function updateLastUpdate(){const el=document.getElementById('last-upd');if(el)el.textContent=`atualizado √†s ${new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}`;}
function showRefreshBar(){document.getElementById('refresh-bar').style.display='flex';}

// ‚ïê‚ïê VIEW TOGGLE ‚ïê‚ïê
function setView(v){
  currentView=v;
  ['grid','list','kanban'].forEach(k=>document.getElementById(`vbtn-${k}`).classList.toggle('active',k===v));
  applyCurrentFilter();
}

// ‚ïê‚ïê RENDER ‚ïê‚ïê
function renderAll(open,closedQty){updateStats(open,closedQty);showUI();applyCurrentFilter();}
function updateStats(tickets,closedQty){
  const c=p=>tickets.filter(t=>normPrio(t.priority)===p).length;
  const s=(id,val)=>{const el=document.getElementById(id);if(el)el.textContent=val;};
  s('stat-alta',c('alta'));s('stat-media',c('media'));s('stat-baixa',c('baixa'));
  s('stat-total',tickets.length);s('stat-closed',closedQty);
}
function showUI(){document.getElementById('stats-bar').classList.add('visible');document.getElementById('toolbar').classList.add('visible');}
function applyCurrentFilter(){
  const filtered=currentFilter==='all'?allTickets:allTickets.filter(t=>normPrio(t.priority)===currentFilter);
  renderTickets(filtered);
}

// ‚ïê‚ïê HELPERS ‚ïê‚ïê
function normPrio(p){
  if(!p)return'normal';
  const v=p.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  if(v.includes('alta')||v==='high'||v==='3')return'alta';
  if(v.includes('media')||v==='medium'||v==='2')return'media';
  if(v.includes('baixa')||v==='low'||v==='1')return'baixa';
  return'normal';
}
function prioLabel(p){return{alta:'Alta',media:'M√©dia',baixa:'Baixa',normal:'Normal'}[normPrio(p)]||p;}
function fmtDate(ds){if(!ds)return'‚Äî';try{return new Date(ds).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'});}catch{return ds;}}
function initials(n){if(!n)return'?';return n.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();}
function calcDaysOpen(s){try{return Math.round((new Date()-new Date(s))/86400000);}catch{return'‚Äî';}}

function getTaskIDs(t){
  return [...new Set([...(t.taskIDs||[]),...(localTaskMap[t.id]||[])])];
}
function taskBadgesHTML(t,cls='task-badge'){
  const ids=getTaskIDs(t);
  if(!ids.length)return'';
  return ids.map(id=>{
    const nome=localTaskColaborador[id]||'';
    const colab=nome?`<span style="font-size:.58rem;color:var(--text-muted);font-weight:600;margin-left:3px;">\u{1F464} ${nome}</span>`:'';
    return `<span style="display:inline-flex;align-items:center;gap:2px;" onclick="event.stopPropagation()"><span class="${cls}" onclick="showTaskInfo(${id},event)"># ${id}</span>${colab}</span>`;
  }).join('');
}
async function showTaskInfo(taskId,evt){
  if(evt)evt.stopPropagation();
  const overlay=document.getElementById('task-detail-overlay');
  const body=document.getElementById('td-body');
  const idEl=document.getElementById('td-id');
  const titleEl=document.getElementById('td-title');
  idEl.innerHTML=`<small>TAREFA</small>#${taskId}`;
  titleEl.textContent='';
  body.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;padding:3rem;"><div class="spinner"></div></div>`;
  overlay.classList.add('open');
  document.body.style.overflow='hidden';
  try {
    const res=await fetch(`${BASE_API}/api/tasks/${taskId}`);
    const data=await res.json();
    if(!res.ok)throw new Error(data.error||`Erro ${res.status}`);
    const tk=data?.result||data;
    titleEl.textContent=tk.taskTypeDescription||'Tarefa';
    const statusLabel=tk.finished?'‚úÖ Conclu√≠da':tk.checkIn&&!tk.checkOut?'üîÑ Em andamento':'‚è≥ Pendente';
    const prioMap={'1':'Baixa','2':'M√©dia','3':'Alta'};
    const prioVal=prioMap[String(tk.priority)]||tk.priority||'‚Äî';
    body.innerHTML=`
      <div class="modal-section">
        <div class="section-label">Informa√ß√µes Gerais</div>
        <div class="info-grid">
          <div class="info-item"><div class="info-key">STATUS</div><div class="info-val highlight">${statusLabel}</div></div>
          <div class="info-item"><div class="info-key">PRIORIDADE</div><div class="info-val">${prioVal}</div></div>
          <div class="info-item"><div class="info-key">TIPO DE TAREFA</div><div class="info-val">${tk.taskTypeDescription||'‚Äî'}</div></div>
          <div class="info-item"><div class="info-key">CLIENTE</div><div class="info-val">${tk.customerDescription||'‚Äî'}</div></div>
          <div class="info-item"><div class="info-key">COLABORADOR RESPONS√ÅVEL</div><div class="info-val">${tk.userToName||localTaskColaborador[taskId]||'‚Äî'}</div></div>
          <div class="info-item"><div class="info-key">CRIADO POR</div><div class="info-val">${tk.userFromName||'‚Äî'}</div></div>
        </div>
      </div>
      <div class="modal-section">
        <div class="section-label">üìÖ Datas</div>
        <div class="dates-grid">
          <div class="date-card"><div class="date-icon">üìù</div><div class="date-label">Cria√ß√£o</div><div class="date-value">${fmtDate(tk.creationDate)}</div><div class="date-time">${tk.creationDate?new Date(tk.creationDate).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):''}</div></div>
          <div class="date-card"><div class="date-icon">üìÖ</div><div class="date-label">Agendada</div><div class="date-value">${fmtDate(tk.taskDate)}</div><div class="date-time">${tk.taskDate?new Date(tk.taskDate).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):''}</div></div>
          <div class="date-card"><div class="date-icon">üìç</div><div class="date-label">Check-in</div><div class="date-value">${tk.checkIn?fmtDate(tk.checkInDate):'‚Äî'}</div><div class="date-time">${tk.checkIn&&tk.checkInDate?new Date(tk.checkInDate).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):''}</div></div>
        </div>
      </div>
      ${tk.address?`<div class="modal-section"><div class="section-label">üìç Endere√ßo</div><div class="desc-box">${tk.address}</div></div>`:''}
      ${tk.orientation?`<div class="modal-section"><div class="section-label">üìã Orienta√ß√£o</div><div class="desc-box" style="max-height:160px;">${tk.orientation.replace(/\n/g,'<br>')}</div></div>`:''}
      ${tk.report?`<div class="modal-section"><div class="section-label">üìÑ Relat√≥rio</div><div class="desc-box">${tk.report}</div></div>`:''}
      ${tk.taskUrl?`<div class="modal-section"><a href="${tk.taskUrl}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;font-size:.8rem;font-weight:700;color:var(--brand);text-decoration:none;">üîó Abrir tarefa no Auvo</a></div>`:''}
    `;
  } catch(err) {
    body.innerHTML=`<div class="modal-alert">‚ùå ${err.message}</div>`;
  }
}
function closeTaskDetail(){
  document.getElementById('task-detail-overlay').classList.remove('open');
  document.body.style.overflow='';
}

// ‚ïê‚ïê RENDER TICKETS ‚ïê‚ïê
function renderTickets(tickets){
  const c=document.getElementById('tickets-container');
  if(!tickets.length){c.innerHTML=`<div class="state-box"><div class="icon">‚úÖ</div><p>Nenhum ticket aberto para este filtro.</p></div>`;return;}
  const sorted=[...tickets].sort((a,b)=>{const o={alta:0,media:1,baixa:2,normal:3};return(o[normPrio(a.priority)]??4)-(o[normPrio(b.priority)]??4);});
  if(currentView==='grid') renderGrid(sorted,c);
  else if(currentView==='list') renderList(sorted,c);
  else renderKanban(sorted,c);
}

// ‚îÄ‚îÄ GRID ‚îÄ‚îÄ
function renderGrid(tickets,container){
  container.innerHTML='<div class="tickets-grid" id="tg"></div>';
  const grid=document.getElementById('tg');
  tickets.forEach((t,i)=>{
    const prio=normPrio(t.priority);
    const card=document.createElement('div');
    card.className=`ticket-card prio-${prio}`;
    card.dataset.ticketId=t.id;
    card.style.animationDelay=`${i*.03}s`;
    card.onclick=()=>openModal(t);
    const taskHtml=taskBadgesHTML(t,'task-badge');
    card.innerHTML=`
      ${prio==='alta'?`<div class="alert-banner"><span class="blink"></span>PRIORIDADE ALTA</div>`:''}
      <div class="card-header">
        <div class="ticket-id"><span>TICKET</span>#${t.id}</div>
        <span class="prio-badge ${prio}">${prioLabel(t.priority)}</span>
      </div>
      <div class="ticket-title">${t.title||'Sem t√≠tulo'}</div>
      <div class="assignee-row">
        <div class="avatar">${initials(t.userResponsableName)}</div>
        <div class="assignee-info">
          <div class="assignee-name">${t.userResponsableName||'‚Äî'}</div>
          <div class="assignee-label">RESPONS√ÅVEL</div>
        </div>
      </div>
      ${taskHtml?`<div class="card-tasks">${taskHtml}</div>`:''}
      <div class="card-footer">
        <span class="status-chip">${t.statusDescription||'‚Äî'}</span>
        <span class="card-date">${fmtDate(t.creationDate)}</span>
        <span class="expand-hint">ver ‚Üí</span>
      </div>`;
    grid.appendChild(card);
  });
}

// ‚îÄ‚îÄ LIST ‚îÄ‚îÄ
function renderList(tickets,container){
  container.innerHTML=`
    <div class="table-wrap">
      <table class="tickets-table">
        <thead><tr>
          <th>#</th><th>T√≠tulo</th><th>Cliente</th><th>Respons√°vel</th>
          <th>Prioridade</th><th>Status</th><th>Abertura</th><th>Enc. Prev.</th><th>Tarefas</th>
        </tr></thead>
        <tbody id="tl"></tbody>
      </table>
    </div>`;
  const tbody=document.getElementById('tl');
  tickets.forEach(t=>{
    const prio=normPrio(t.priority);
    const tr=document.createElement('tr');
    tr.className=`trow-${prio}`;
    tr.dataset.ticketId=t.id;
    tr.onclick=()=>openModal(t);
    const ids=getTaskIDs(t);
    tr.innerHTML=`
      <td class="table-id">#${t.id}</td>
      <td class="table-title" title="${t.title||''}">${t.title||'‚Äî'}</td>
      <td class="table-client" title="${t.customerName||''}">${t.customerName||'‚Äî'}</td>
      <td class="table-assignee"><div style="display:flex;align-items:center;gap:6px;"><div class="avatar" style="width:22px;height:22px;font-size:.54rem;">${initials(t.userResponsableName)}</div>${t.userResponsableName||'‚Äî'}</div></td>
      <td><span class="prio-badge ${prio}">${prioLabel(t.priority)}</span></td>
      <td><span class="status-chip">${t.statusDescription||'‚Äî'}</span></td>
      <td class="table-date">${fmtDate(t.creationDate)}</td>
      <td class="table-date">${t.endDate?fmtDate(t.endDate):'00/00/0000'}</td>
      <td><div class="table-tasks" onclick="event.stopPropagation()">${ids.map(id=>{const n=localTaskColaborador[id]||'';const col=n?`<span style="font-size:.58rem;color:var(--text-muted);font-weight:600;margin-left:2px;">\u{1F464} ${n}</span>`:'';return `<span style="display:inline-flex;align-items:center;gap:2px;" onclick="event.stopPropagation()"><span class="task-badge" onclick="showTaskInfo(${id},event)">#${id}</span>${col}</span>`;}).join('')||'<span style="color:var(--text-muted);font-size:.7rem;">‚Äî</span>'}</div></td>`;
    tbody.appendChild(tr);
  });
}

// ‚îÄ‚îÄ KANBAN ‚îÄ‚îÄ
function renderKanban(tickets,container){
  const cols={alta:[],media:[],baixa:[]};
  tickets.forEach(t=>{const p=normPrio(t.priority);(cols[p]||cols.baixa).push(t);});
  const labels={alta:'üî¥ Alta',media:'üü° M√©dia',baixa:'üü¢ Baixa'};
  container.innerHTML='<div class="kanban-board" id="kb"></div>';
  const board=document.getElementById('kb');
  ['alta','media','baixa'].forEach(prio=>{
    const col=document.createElement('div');
    col.className=`kanban-col ${prio}`;
    col.innerHTML=`
      <div class="kanban-header ${prio}">
        <div class="kanban-col-title">${labels[prio]}</div>
        <span class="kanban-count">${cols[prio].length}</span>
      </div>
      <div class="kanban-cards" id="kc-${prio}"></div>`;
    board.appendChild(col);
    const div=document.getElementById(`kc-${prio}`);
    if(!cols[prio].length){div.innerHTML=`<div style="text-align:center;padding:1.5rem 1rem;color:var(--text-muted);font-size:.75rem;">Nenhum ticket</div>`;return;}
    cols[prio].forEach((t,i)=>{
      const card=document.createElement('div');
      card.className='kanban-card';card.dataset.ticketId=t.id;
      card.style.animationDelay=`${i*.04}s`;card.onclick=()=>openModal(t);
      const ids=getTaskIDs(t);
      card.innerHTML=`
        <div class="kcard-id">#${t.id} <span style="font-weight:500;color:var(--text-muted);font-size:.66rem;">${t.customerName||''}</span></div>
        <div class="kcard-title">${t.title||'Sem t√≠tulo'}</div>
        ${ids.length?`<div class="kcard-tasks" onclick="event.stopPropagation()">${ids.map(id=>{const n=localTaskColaborador[id]||'';const col=n?`<span style="font-size:.58rem;color:var(--text-muted);font-weight:600;margin-left:2px;">\u{1F464} ${n}</span>`:'';return `<span style="display:inline-flex;align-items:center;gap:2px;" onclick="event.stopPropagation()"><span class="task-badge" onclick="showTaskInfo(${id},event)">#${id}</span>${col}</span>`;}).join('')}</div>`:''}
        <div class="kcard-footer">
          <div class="kcard-assignee"><div class="kcard-av">${initials(t.userResponsableName)}</div>${t.userResponsableName||'‚Äî'}</div>
          <span class="kcard-date">${fmtDate(t.creationDate)}</span>
        </div>`;
      div.appendChild(card);
    });
  });
}

function filterTickets(filter,btn){
  currentFilter=filter;
  document.querySelectorAll('.filter-btn').forEach(b=>b.className='filter-btn');
  btn.classList.add(`active-${filter}`);
  applyCurrentFilter();
}

// ‚ïê‚ïê MODAL TICKET ‚ïê‚ïê
function openModal(t){
  currentTicket=t;
  const prio=normPrio(t.priority);
  document.getElementById('modal').className=`modal prio-${prio}`;
  document.getElementById('modal-id').innerHTML=`<small>TICKET</small>#${t.id}`;
  document.getElementById('modal-title').textContent=t.title||'Sem t√≠tulo';
  const ids=getTaskIDs(t);
  const tasksSection=ids.length?`
    <div class="modal-section">
      <div class="section-label">üîß Tarefas Vinculadas</div>
      <div class="modal-tasks" id="modal-tasks-list">
        ${ids.map(id=>`<span class="modal-task-badge"># ${id}</span>`).join('')}
      </div>
    </div>`:'';

  document.getElementById('modal-body').innerHTML=`
    ${prio==='alta'?`<div class="modal-alert"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>PRIORIDADE ALTA ‚Äî requer aten√ß√£o imediata.</div>`:''}
    <div class="modal-section">
      <div class="section-label">Informa√ß√µes Gerais</div>
      <div class="info-grid">
        <div class="info-item"><div class="info-key">PRIORIDADE</div><div class="info-val highlight ${prio}">${prioLabel(t.priority)}</div></div>
        <div class="info-item"><div class="info-key">STATUS</div><div class="info-val highlight">${t.statusDescription||'‚Äî'}</div></div>
        <div class="info-item"><div class="info-key">TIPO DE SOLICITA√á√ÉO</div><div class="info-val">${t.requestTypeDescription||'‚Äî'}</div></div>
        <div class="info-item"><div class="info-key">CLIENTE</div><div class="info-val">${t.customerName||'‚Äî'}</div></div>
        <div class="info-item"><div class="info-key">RESPONS√ÅVEL</div><div class="info-val">${t.userResponsableName||'‚Äî'}</div></div>
        ${t.teamName?`<div class="info-item"><div class="info-key">EQUIPE</div><div class="info-val">${t.teamName}</div></div>`:''}
      </div>
    </div>
    ${tasksSection}
    <div class="modal-section" id="modal-tasks-section" style="${ids.length?'':'display:none'}">
    </div>
    <div class="modal-section">
      <div class="section-label">üìÖ Datas</div>
      <div class="dates-grid">
        <div class="date-card"><div class="date-icon">üìù</div><div class="date-label">Cria√ß√£o</div><div class="date-value">${fmtDate(t.creationDate)}</div><div class="date-time">${t.creationDate?new Date(t.creationDate).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):''}</div></div>
        <div class="date-card"><div class="date-icon">üìÖ</div><div class="date-label">Enc. Previsto</div><div class="date-value">${t.endDate?fmtDate(t.endDate):'00/00/0000'}</div><div class="date-time">${t.endDate?new Date(t.endDate).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):'00:00'}</div></div>
        <div class="date-card"><div class="date-icon">‚è±</div><div class="date-label">Tempo Aberto</div><div class="date-value">${calcDaysOpen(t.creationDate)}</div><div class="date-time">dias</div></div>
      </div>
    </div>
    ${(t.requesterName||t.requesterEmail||t.customerEmail||t.customerPhoneNumber)?`
    <div class="modal-section">
      <div class="section-label">Contato</div>
      <div class="info-grid">
        ${t.requesterName?`<div class="info-item"><div class="info-key">SOLICITANTE</div><div class="info-val">${t.requesterName}</div></div>`:''}
        ${t.requesterEmail?`<div class="info-item"><div class="info-key">E-MAIL</div><div class="info-val">${t.requesterEmail}</div></div>`:''}
        ${t.customerEmail?`<div class="info-item"><div class="info-key">E-MAIL CLIENTE</div><div class="info-val">${t.customerEmail}</div></div>`:''}
        ${t.customerPhoneNumber?`<div class="info-item"><div class="info-key">TELEFONE</div><div class="info-val">${t.customerPhoneNumber}</div></div>`:''}
      </div>
    </div>`:''}
    ${t.description?`<div class="modal-section"><div class="section-label">Descri√ß√£o</div><div class="desc-box">${t.description}</div></div>`:''}
    ${t.customFields?.length?`<div class="modal-section"><div class="section-label">Campos Personalizados</div><div class="info-grid">${t.customFields.map(cf=>`<div class="info-item"><div class="info-key">${cf.customFieldTicket?.title||'Campo'}</div><div class="info-val">${cf.valueDescription||cf.value||'‚Äî'}</div></div>`).join('')}</div></div>`:''}
    <div class="modal-section">
      <div class="section-label">A√ß√µes</div>
      <button class="btn-create-task" onclick="openTaskModal()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
        CRIAR TAREFA A PARTIR DESTE TICKET
      </button>
    </div>`;

  document.getElementById('modal-overlay').classList.add('open');
  document.body.style.overflow='hidden';
}
function closeModal(e){if(e.target===document.getElementById('modal-overlay'))closeModalDirect();}
function closeModalDirect(){document.getElementById('modal-overlay').classList.remove('open');document.body.style.overflow='';}

// ‚ïê‚ïê MODAL CRIAR TAREFA ‚ïê‚ïê
function openTaskModal(){
  if(!currentTicket)return;
  const t=currentTicket,prio=normPrio(t.priority);
  document.getElementById('task-modal-sub').textContent=`Vinculada ao Ticket #${t.id}`;
  document.getElementById('task-origin-badge').textContent=`üé´ Ticket #${t.id} ‚Äî ${t.title||'Sem t√≠tulo'}`;
  document.getElementById('task-titulo').value=t.title||'';
  document.getElementById('task-descricao').value=t.description||'';
  const now=new Date();
  document.getElementById('task-data').value=new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,16);
  const priBox=document.getElementById('prio-inherited-box');
  priBox.className=`prio-inherited prio-${prio}`;
  document.getElementById('prio-inherited-label').textContent=prioLabel(t.priority);
  loadUsers();
  loadTaskTypes().then(()=>{if(t.requestTypeId){const s=document.getElementById('task-tipo');if(s)s.value=String(t.requestTypeId);}});
  document.getElementById('task-modal-overlay').classList.add('open');
}
function closeTaskModal(e){if(e.target===document.getElementById('task-modal-overlay'))closeTaskModalDirect();}
function closeTaskModalDirect(){document.getElementById('task-modal-overlay').classList.remove('open');}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeTaskDetail();closeTaskModalDirect();closeModalDirect();}});

// ‚ïê‚ïê SUBMIT TAREFA ‚ïê‚ïê
async function submitTask(){
  const t=currentTicket;if(!t)return;
  const titulo=document.getElementById('task-titulo').value.trim();
  const colaboradorSel=document.getElementById('task-colaborador');
  const colaborador=colaboradorSel.value;
  const colaboradorNome=colaboradorSel.options[colaboradorSel.selectedIndex]?.text||'';
  const tipo=document.getElementById('task-tipo').value;
  const data=document.getElementById('task-data').value;
  const descricao=document.getElementById('task-descricao').value.trim();
  const orientacao=document.getElementById('task-orientacao').value.trim();
  if(!titulo){showToast('‚ö† Preencha o T√≠tulo.','error');return;}
  if(!colaborador){showToast('‚ö† Selecione o Colaborador.','error');return;}
  if(!tipo){showToast('‚ö† Selecione o Tipo.','error');return;}
  if(!data){showToast('‚ö† Informe a Data.','error');return;}
  if(!descricao){showToast('‚ö† Preencha a Descri√ß√£o do Cliente.','error');return;}

  const prioMap={alta:'3',media:'2',baixa:'1',normal:'1'};
  const taskDateFmt=data.length===16?data+':00':data.slice(0,19);
  const parts=[];
  if(titulo)parts.push(titulo);
  if(colaboradorNome)parts.push('Colaborador Respons√°vel: '+colaboradorNome);
  if(descricao)parts.push('Descri√ß√£o do Cliente: '+descricao);
  if(orientacao)parts.push('Orienta√ß√£o ao Colaborador: '+orientacao);

  const payload={
    idUserTo:parseInt(colaborador),idUserFrom:parseInt(colaborador),
    taskType:parseInt(tipo),taskDate:taskDateFmt,
    orientation:parts.join('\n\n'),
    priority:parseInt(prioMap[normPrio(t.priority)]||'1'),
    latitude:t.customerLatitude||0,longitude:t.customerLongitude||0,
    address:t.customerAddress||t.customerName||'',
    ticketId:t.id,
  };
  if(t.customerId)payload.customerId=parseInt(t.customerId);

  const btn=document.getElementById('btn-submit-task');
  btn.disabled=true;btn.classList.add('loading');
  try {
    const res=await fetch(`${BASE_API}/api/tasks`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const result=await res.json();
    if(!res.ok)throw new Error(result.error||`Erro ${res.status}`);
    const ri=Array.isArray(result?.result)?result.result[0]:result?.result;
    const taskId=ri?.taskID||ri?.id||result?.taskID;
    if(taskId){
      if(!localTaskMap[t.id])localTaskMap[t.id]=[];
      localTaskMap[t.id].push(taskId);
      if(colaboradorNome)localTaskColaborador[taskId]=colaboradorNome;
      updateCardTasks(t.id);
      // Atualiza modal se aberto
      const tasksList=document.getElementById('modal-tasks-list');
      if(tasksList){
        tasksList.innerHTML=getTaskIDs(t).map(id=>`<span class="modal-task-badge"># ${id}</span>`).join('');
        tasksList.closest('.modal-section').style.display='';
      } else {
        // Insere se√ß√£o de tarefas antes da se√ß√£o de a√ß√µes
        const body=document.getElementById('modal-body');
        const acoes=body.querySelector('.modal-section:last-child');
        if(acoes){
          const sec=document.createElement('div');sec.className='modal-section';
          sec.innerHTML=`<div class="section-label">üîß Tarefas Vinculadas</div><div class="modal-tasks" id="modal-tasks-list"><span class="modal-task-badge"># ${taskId}</span></div>`;
          body.insertBefore(sec,acoes);
        }
      }
    }
    showToast(`‚úì Tarefa #${taskId||'?'} criada com sucesso!`);
    closeTaskModalDirect();
  } catch(err){
    console.error(err);showToast('‚ùå '+err.message,'error');
  } finally{
    btn.disabled=false;btn.classList.remove('loading');
  }
}

// Atualiza badges de task nas cards sem re-renderizar tudo
function updateCardTasks(ticketId){
  const t=allTickets.find(x=>x.id===ticketId);if(!t)return;
  const ids=getTaskIDs(t);
  const cards=document.querySelectorAll(`[data-ticket-id="${ticketId}"]`);
  cards.forEach(card=>{
    const isKanban=card.classList.contains('kanban-card');
    const tasksCls=isKanban?'kcard-tasks':'card-tasks';
    let tasksDiv=card.querySelector(`.${tasksCls}`);
    const badgeHtml=ids.map(id=>{const n=localTaskColaborador[id]||'';const col=n?`<span style="font-size:.58rem;color:var(--text-muted);font-weight:600;margin-left:2px;">\u{1F464} ${n}</span>`:'';return `<span style="display:inline-flex;align-items:center;gap:2px;" onclick="event.stopPropagation()"><span class="task-badge" onclick="showTaskInfo(${id},event)"># ${id}</span>${col}</span>`;}).join('');
    if(tasksDiv){tasksDiv.innerHTML=badgeHtml;}
    else{
      const footer=card.querySelector('.card-footer,.kcard-footer');
      if(footer){const d=document.createElement('div');d.className=tasksCls;d.innerHTML=badgeHtml;card.insertBefore(d,footer);}
    }
  });
  // Table row
  const tr=document.querySelector(`tr[data-ticket-id="${ticketId}"]`);
  if(tr){const td=tr.querySelector('.table-tasks');if(td)td.innerHTML=ids.map(id=>{const n=localTaskColaborador[id]||'';const col=n?`<span style="font-size:.58rem;color:var(--text-muted);font-weight:600;margin-left:2px;">\u{1F464} ${n}</span>`:'';return `<span style="display:inline-flex;align-items:center;gap:2px;" onclick="event.stopPropagation()"><span class="task-badge" onclick="showTaskInfo(${id},event)">#${id}</span>${col}</span>`;}).join('');}
}

// ‚ïê‚ïê HELPERS UI ‚ïê‚ïê
let toastTimeout;
function showToast(msg,type='success'){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className=`toast show${type==='error'?' error':type==='info'?' info':''}`;
  clearTimeout(toastTimeout);toastTimeout=setTimeout(()=>el.classList.remove('show'),4500);
}
function setLoading(on){
  const btn=document.getElementById('btn-load');
  btn.disabled=on;btn.textContent=on?'‚è≥ Carregando...':'‚ñ∂ CARREGAR';
  if(on)document.getElementById('tickets-container').innerHTML=`<div class="state-box"><div class="spinner"></div><p>Buscando tickets na API do Auvo...</p></div>`;
}
function showError(msg){const b=document.getElementById('error-box');b.textContent='‚ùå '+msg;b.style.display='block';}
function hideError(){const e=document.getElementById('error-box');if(e)e.style.display='none';}
function handleFetchError(err){console.error(err);showError(err.message);}

window.onload=()=>startSession();
</script>
</body>
</html>
