<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auvo Tickets â€” Central de Chamados</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    /* Auvo brand colors */
    --auvo-purple: #6f2da8;
    --auvo-purple-dark: #5a2090;
    --auvo-purple-light: #8b4bc8;
    --auvo-purple-xlight: #f0e8fa;

    --bg: #f4f5f7;
    --surface: #ffffff;
    --surface2: #f8f9fb;
    --surface3: #eef0f4;
    --border: #e2e5ea;
    --border2: #d0d4dc;

    --red: #e53935; --red-dim: rgba(229,57,53,0.10); --red-glow: rgba(229,57,53,0.30);
    --amber: #f59c00; --amber-dim: rgba(245,156,0,0.12);
    --green: #2e9e5b; --green-dim: rgba(46,158,91,0.10);
    --blue: #2563eb; --blue-dim: rgba(37,99,235,0.10);
    --purple: var(--auvo-purple); --purple-dim: rgba(111,45,168,0.10);

    --text: #1a1d23;
    --text-muted: #6b7280;
    --text-dim: #4b5563;

    --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.10);
    --shadow-lg: 0 8px 28px rgba(0,0,0,0.12);
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Nunito Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}

  /* â”€â”€ HEADER (Auvo style â€” roxo sÃ³lido) â”€â”€ */
  header{
    position:sticky;top:0;z-index:100;
    background:var(--auvo-purple);
    padding:0 2rem;height:58px;
    display:flex;align-items:center;justify-content:space-between;gap:1rem;
    box-shadow:0 2px 8px rgba(111,45,168,0.35);
  }
  .logo{
    font-family:'Nunito Sans',sans-serif;font-weight:800;font-size:1rem;
    letter-spacing:0.03em;display:flex;align-items:center;gap:10px;
    white-space:nowrap;color:#fff;
  }
  .logo-icon{
    width:32px;height:32px;background:rgba(255,255,255,0.18);
    border-radius:8px;display:flex;align-items:center;justify-content:center;
    font-size:1rem;
  }
  .logo-dot{display:none;}
  @keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:0.5}}
  .header-center{display:flex;align-items:center;gap:12px;flex:1;justify-content:center;}
  .refresh-bar{
    display:flex;align-items:center;gap:10px;
    background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.2);
    border-radius:8px;padding:5px 12px;font-size:0.7rem;color:rgba(255,255,255,0.85);
  }
  .refresh-bar .live-dot{width:7px;height:7px;border-radius:50%;background:#4ade80;flex-shrink:0;box-shadow:0 0 6px #4ade80;}
  .refresh-bar .live-dot.paused{background:rgba(255,255,255,0.4);box-shadow:none;}
  .refresh-bar .live-dot.syncing{background:#fbbf24;box-shadow:0 0 6px #fbbf24;animation:blink-amber 0.6s ease-in-out infinite;}
  @keyframes blink-amber{0%,100%{opacity:1}50%{opacity:0.3}}
  .refresh-bar .refresh-label{color:rgba(255,255,255,0.9);letter-spacing:0.04em;font-weight:600;}
  .countdown-wrap{position:relative;width:32px;height:32px;flex-shrink:0;}
  .countdown-wrap svg{transform:rotate(-90deg);}
  .countdown-ring-bg{fill:none;stroke:rgba(255,255,255,0.2);stroke-width:3;}
  .countdown-ring{fill:none;stroke:#c084fc;stroke-width:3;stroke-linecap:round;transition:stroke-dashoffset 1s linear;stroke-dasharray:88;stroke-dashoffset:0;}
  .countdown-ring.urgent{stroke:#f87171;}
  .countdown-num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:700;color:rgba(255,255,255,0.85);}
  .btn-pause{
    font-family:'Nunito Sans',sans-serif;font-size:0.68rem;font-weight:700;
    background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.25);
    color:rgba(255,255,255,0.9);padding:4px 10px;border-radius:5px;cursor:pointer;
    transition:all 0.2s;white-space:nowrap;
  }
  .btn-pause:hover{background:rgba(255,255,255,0.22);}
  .last-update{font-size:0.62rem;color:rgba(255,255,255,0.65);white-space:nowrap;}
  .header-right{display:flex;align-items:center;gap:8px;}
  .creds-form{display:flex;gap:8px;align-items:center;}
  .creds-form input{
    background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.25);
    color:#fff;font-family:'Nunito Sans',sans-serif;font-size:0.82rem;
    padding:6px 12px;border-radius:6px;width:165px;outline:none;transition:all 0.2s;
  }
  .creds-form input:focus{background:rgba(255,255,255,0.2);border-color:rgba(255,255,255,0.5);}
  .creds-form input::placeholder{color:rgba(255,255,255,0.5);}
  .btn-load{
    font-family:'Nunito Sans',sans-serif;font-weight:800;font-size:0.82rem;
    letter-spacing:0.02em;background:#fff;color:var(--auvo-purple);
    border:none;padding:7px 20px;border-radius:6px;cursor:pointer;
    transition:all 0.2s;white-space:nowrap;box-shadow:0 2px 6px rgba(0,0,0,0.12);
  }
  .btn-load:hover{background:#f0e8fa;box-shadow:0 4px 12px rgba(0,0,0,0.18);}
  .btn-load:disabled{opacity:0.5;cursor:not-allowed;}

  /* â”€â”€ TOAST â”€â”€ */
  .toast{
    position:fixed;bottom:1.5rem;right:1.5rem;z-index:9999;
    background:var(--surface);border:1px solid var(--green);color:var(--green);
    border-radius:10px;padding:12px 18px;font-size:0.8rem;
    font-family:'Nunito Sans',sans-serif;font-weight:700;
    display:flex;align-items:center;gap:10px;
    box-shadow:var(--shadow-lg);
    transform:translateY(80px);opacity:0;
    transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1);pointer-events:none;
  }
  .toast.show{transform:translateY(0);opacity:1;}
  .toast.error{border-color:var(--red);color:var(--red);}
  .toast.info{border-color:var(--blue);color:var(--blue);}

  /* â”€â”€ MAIN â”€â”€ */
  main{position:relative;z-index:1;max-width:1400px;margin:0 auto;padding:1.75rem 2rem;}
  .status-note{
    display:flex;align-items:center;gap:8px;
    background:rgba(46,158,91,0.08);border:1px solid rgba(46,158,91,0.25);
    border-radius:8px;padding:8px 14px;margin-bottom:1.5rem;
    font-size:0.78rem;color:var(--green);display:none;
  }

  /* â”€â”€ STATS â”€â”€ */
  .stats-bar{display:grid;grid-template-columns:repeat(5,1fr);gap:1rem;margin-bottom:1.75rem;opacity:0;transform:translateY(16px);transition:all 0.4s ease;}
  .stats-bar.visible{opacity:1;transform:translateY(0);}
  .stat-card{
    background:var(--surface);border:1px solid var(--border);
    border-radius:12px;padding:1.1rem 1.2rem;
    position:relative;overflow:hidden;
    box-shadow:var(--shadow-sm);
  }
  .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
  .stat-card.alta::before{background:var(--red);}
  .stat-card.media::before{background:var(--amber);}
  .stat-card.baixa::before{background:var(--green);}
  .stat-card.total::before{background:var(--auvo-purple);}
  .stat-card.closed::before{background:#bbb;}
  .stat-label{font-size:0.7rem;color:var(--text-muted);letter-spacing:0.05em;text-transform:uppercase;font-weight:600;margin-bottom:6px;}
  .stat-value{font-size:2rem;font-weight:800;line-height:1;}
  .stat-card.alta .stat-value{color:var(--red);}
  .stat-card.media .stat-value{color:var(--amber);}
  .stat-card.baixa .stat-value{color:var(--green);}
  .stat-card.total .stat-value{color:var(--auvo-purple);}
  .stat-card.closed .stat-value{color:#9ca3af;}
  .stat-sub{font-size:0.65rem;color:var(--text-muted);margin-top:4px;}

  /* â”€â”€ FILTERS â”€â”€ */
  .filter-bar{display:flex;gap:8px;margin-bottom:1.5rem;flex-wrap:wrap;opacity:0;transition:opacity 0.4s ease 0.2s;}
  .filter-bar.visible{opacity:1;}
  .filter-btn{
    font-family:'Nunito Sans',sans-serif;font-size:0.78rem;font-weight:700;
    padding:6px 16px;border-radius:20px;border:1px solid var(--border);
    background:var(--surface);color:var(--text-dim);cursor:pointer;transition:all 0.2s;
  }
  .filter-btn:hover{border-color:var(--auvo-purple);color:var(--auvo-purple);}
  .filter-btn.active-all{background:var(--auvo-purple);border-color:var(--auvo-purple);color:#fff;}
  .filter-btn.active-alta{background:var(--red-dim);border-color:var(--red);color:var(--red);}
  .filter-btn.active-media{background:var(--amber-dim);border-color:var(--amber);color:var(--amber);}
  .filter-btn.active-baixa{background:var(--green-dim);border-color:var(--green);color:var(--green);}

  /* â”€â”€ TICKET GRID â”€â”€ */
  .tickets-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem;}
  .ticket-card{
    background:var(--surface);border:1px solid var(--border);
    border-radius:12px;padding:1.2rem;cursor:pointer;
    transition:all 0.22s ease;position:relative;overflow:hidden;
    animation:cardIn 0.3s ease both;box-shadow:var(--shadow-sm);
  }
  @keyframes cardIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
  .ticket-card:hover{border-color:var(--auvo-purple-light);transform:translateY(-2px);box-shadow:var(--shadow-md);}
  .ticket-card.prio-alta{border-color:rgba(229,57,53,0.35);border-left:4px solid var(--red);}
  .ticket-card.prio-alta::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--red);}
  .ticket-card.prio-alta:hover{box-shadow:0 8px 24px rgba(229,57,53,0.15);}
  .ticket-card.removing{animation:cardOut 0.5s ease forwards;}
  @keyframes cardOut{to{opacity:0;transform:scale(0.9);height:0;margin:0;padding:0;border-width:0;overflow:hidden;}}

  /* ALERT BANNER â€” mantido exatamente, sÃ³ cores ajustadas */
  .alert-banner{
    display:flex;align-items:center;gap:6px;
    background:rgba(229,57,53,0.08);border:1px solid rgba(229,57,53,0.3);
    border-radius:6px;padding:4px 10px;margin-bottom:10px;
    font-size:0.68rem;color:var(--red);letter-spacing:0.06em;
    text-transform:uppercase;font-weight:700;
  }
  .alert-banner .blink{width:6px;height:6px;background:var(--red);border-radius:50%;animation:blink 1s ease-in-out infinite;flex-shrink:0;}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}

  .card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:8px;}
  .ticket-id{font-size:1.2rem;font-weight:800;line-height:1;color:var(--auvo-purple);}
  .ticket-id span{font-size:0.65rem;color:var(--text-muted);font-weight:600;display:block;margin-bottom:2px;letter-spacing:0.08em;text-transform:uppercase;}
  .prio-badge{font-size:0.7rem;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;padding:3px 10px;border-radius:20px;flex-shrink:0;}
  .prio-badge.alta{background:var(--red-dim);color:var(--red);border:1px solid rgba(229,57,53,0.35);}
  .prio-badge.media{background:var(--amber-dim);color:var(--amber);border:1px solid rgba(245,156,0,0.3);}
  .prio-badge.baixa{background:var(--green-dim);color:var(--green);border:1px solid rgba(46,158,91,0.3);}
  .prio-badge.normal{background:var(--blue-dim);color:var(--blue);border:1px solid rgba(37,99,235,0.3);}
  .ticket-title{font-size:0.85rem;color:var(--text-dim);margin-bottom:12px;line-height:1.45;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
  .assignee-row{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface2);border-radius:8px;margin-bottom:10px;border:1px solid var(--border);}
  .avatar{
    width:28px;height:28px;border-radius:50%;
    background:linear-gradient(135deg,var(--auvo-purple),var(--auvo-purple-light));
    display:flex;align-items:center;justify-content:center;
    font-size:0.65rem;font-weight:700;color:#fff;flex-shrink:0;text-transform:uppercase;
  }
  .assignee-info{flex:1;min-width:0;}
  .assignee-name{font-size:0.78rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600;}
  .assignee-label{font-size:0.62rem;color:var(--text-muted);letter-spacing:0.04em;text-transform:uppercase;font-weight:600;}
  .card-footer{display:flex;align-items:center;justify-content:space-between;gap:6px;}
  .status-chip{font-size:0.65rem;padding:3px 9px;border-radius:20px;background:var(--auvo-purple-xlight);color:var(--auvo-purple);border:1px solid rgba(111,45,168,0.2);font-weight:700;}
  .card-date{font-size:0.65rem;color:var(--text-muted);font-weight:600;}
  .expand-hint{font-size:0.65rem;color:var(--auvo-purple);display:flex;align-items:center;gap:4px;opacity:0;transition:opacity 0.2s;font-weight:700;}
  .ticket-card:hover .expand-hint{opacity:1;}

  /* â”€â”€ MODAIS BASE â”€â”€ */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;pointer-events:none;transition:opacity 0.25s ease;}
  .modal-overlay.open{opacity:1;pointer-events:all;}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:680px;max-height:88vh;overflow-y:auto;transform:scale(0.95) translateY(16px);transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);position:relative;box-shadow:var(--shadow-lg);}
  .modal-overlay.open .modal{transform:scale(1) translateY(0);}
  .modal.prio-alta{border-top:4px solid var(--red);}
  .modal-header{padding:1.5rem 1.5rem 1rem;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:1;border-radius:16px 16px 0 0;}
  .modal-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:8px;}
  .modal-id{font-size:1.7rem;font-weight:800;line-height:1;color:var(--auvo-purple);}
  .modal-id small{font-size:0.72rem;font-weight:600;color:var(--text-muted);display:block;margin-bottom:4px;letter-spacing:0.08em;text-transform:uppercase;}
  .modal-close{width:32px;height:32px;background:var(--surface2);border:1px solid var(--border);border-radius:50%;color:var(--text-muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;transition:all 0.2s;}
  .modal-close:hover{background:var(--auvo-purple-xlight);color:var(--auvo-purple);}
  .modal-title{font-size:0.95rem;color:var(--text-dim);line-height:1.5;font-weight:500;}
  .modal-body{padding:1.5rem;}
  .modal-alert{
    background:var(--red-dim);border:1px solid rgba(229,57,53,0.3);
    border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:10px;
    margin-bottom:1.5rem;color:var(--red);font-size:0.82rem;font-weight:700;
  }
  .modal-section{margin-bottom:1.5rem;}
  .section-label{font-size:0.68rem;color:var(--auvo-purple);letter-spacing:0.1em;text-transform:uppercase;font-weight:800;margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--auvo-purple-xlight);}
  .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .info-item{background:var(--surface2);border-radius:8px;padding:10px 12px;border:1px solid var(--border);}
  .info-item.full{grid-column:1/-1;}
  .info-key{font-size:0.64rem;color:var(--text-muted);letter-spacing:0.07em;text-transform:uppercase;font-weight:700;margin-bottom:4px;}
  .info-val{font-size:0.84rem;color:var(--text);word-break:break-word;font-weight:500;}
  .info-val.highlight{font-weight:800;font-size:0.92rem;}
  .info-val.alta{color:var(--red);} .info-val.media{color:var(--amber);} .info-val.baixa{color:var(--green);} .info-val.normal{color:var(--blue);}
  .dates-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
  .date-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center;}
  .date-card .date-icon{font-size:1.2rem;margin-bottom:6px;}
  .date-card .date-label{font-size:0.62rem;color:var(--text-muted);letter-spacing:0.08em;text-transform:uppercase;font-weight:700;margin-bottom:4px;}
  .date-card .date-value{font-size:0.82rem;font-weight:800;color:var(--text);}
  .date-card .date-time{font-size:0.65rem;color:var(--text-muted);margin-top:2px;}
  .desc-box{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;font-size:0.82rem;color:var(--text-dim);line-height:1.6;max-height:120px;overflow-y:auto;}

  /* â”€â”€ BOTÃƒO CRIAR TAREFA â”€â”€ */
  .btn-create-task{
    width:100%; margin-top:0.5rem;
    font-family:'Nunito Sans',sans-serif; font-weight:800; font-size:0.85rem;
    background:var(--auvo-purple);
    border:none; color:#fff;
    padding:12px 20px; border-radius:10px; cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:10px;
    transition:all 0.2s;box-shadow:0 4px 12px rgba(111,45,168,0.3);
  }
  .btn-create-task:hover{background:var(--auvo-purple-dark);box-shadow:0 6px 18px rgba(111,45,168,0.4);}
  .btn-create-task svg{flex-shrink:0;}

  /* â”€â”€ MODAL CRIAR TAREFA â”€â”€ */
  .task-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);backdrop-filter:blur(5px);z-index:2000;display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;pointer-events:none;transition:opacity 0.25s ease;}
  .task-modal-overlay.open{opacity:1;pointer-events:all;}

  .task-modal{
    background:var(--surface);border:1px solid var(--border);
    border-radius:16px;width:100%;max-width:620px;max-height:90vh;
    overflow-y:auto;transform:scale(0.95) translateY(20px);
    transition:transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
    box-shadow:var(--shadow-lg);
  }
  .task-modal-overlay.open .task-modal{transform:scale(1) translateY(0);}

  .task-modal-header{
    padding:1.4rem 1.5rem 1rem;
    background:linear-gradient(135deg, var(--auvo-purple), var(--auvo-purple-light));
    border-bottom:1px solid var(--border);
    border-radius:16px 16px 0 0;
    position:sticky;top:0;z-index:1;
  }
  .task-modal-top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:6px;}
  .task-modal-title{font-size:1.1rem;font-weight:800;color:#fff;letter-spacing:0.02em;display:flex;align-items:center;gap:8px;}
  .task-modal-sub{font-size:0.75rem;color:rgba(255,255,255,0.75);font-weight:600;}

  /* Origin badge */
  .origin-badge{
    display:inline-flex;align-items:center;gap:6px;
    background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);
    border-radius:6px;padding:4px 10px;font-size:0.7rem;color:#fff;
    letter-spacing:0.04em;margin-top:6px;font-weight:600;
  }

  /* Prio herdada */
  .prio-inherited{
    display:flex;align-items:center;gap:8px;
    background:var(--surface2);border:1px solid var(--border);
    border-radius:8px;padding:10px 14px;margin-bottom:1.2rem;
    font-size:0.82rem;color:var(--text-dim);font-weight:500;
  }
  .prio-inherited strong{font-weight:800;font-size:0.88rem;}
  .prio-inherited.prio-alta strong{color:var(--red);}
  .prio-inherited.prio-media strong{color:var(--amber);}
  .prio-inherited.prio-baixa strong{color:var(--green);}
  .prio-inherited.prio-normal strong{color:var(--blue);}
  .prio-lock{font-size:0.68rem;color:var(--text-muted);margin-left:auto;display:flex;align-items:center;gap:4px;}

  /* Form */
  .task-form{padding:1.4rem 1.5rem;}
  .form-group{margin-bottom:1.1rem;}
  .form-label{font-size:0.72rem;color:var(--text-muted);letter-spacing:0.06em;text-transform:uppercase;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:4px;}
  .form-label .req{color:var(--red);}
  .form-label .lbl-hint{color:var(--auvo-purple);font-size:0.65rem;margin-left:auto;letter-spacing:0;font-weight:600;}

  .form-input, .form-select, .form-textarea{
    width:100%;background:var(--surface2);border:1px solid var(--border);
    color:var(--text);font-family:'Nunito Sans',sans-serif;font-size:0.85rem;font-weight:500;
    padding:10px 12px;border-radius:8px;outline:none;
    transition:border-color 0.2s, box-shadow 0.2s;
    appearance:none;
  }
  .form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--auvo-purple);box-shadow:0 0 0 3px rgba(111,45,168,0.08);}
  .form-input::placeholder,.form-textarea::placeholder{color:var(--text-muted);}
  .form-select{cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;}
  .form-select option{background:var(--surface);color:var(--text);}
  .form-textarea{resize:vertical;min-height:90px;line-height:1.5;}

  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}

  /* Loading state for selects */
  .select-loading{position:relative;}
  .select-loading::after{content:'';position:absolute;right:36px;top:50%;transform:translateY(-50%);width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--auvo-purple);border-radius:50%;animation:spin 0.7s linear infinite;}
  @keyframes spin{to{transform:translateY(-50%) rotate(360deg)}}

  .select-error-note{font-size:0.7rem;color:var(--amber);margin-top:4px;display:none;font-weight:600;}

  /* Date input */
  input[type="datetime-local"]::-webkit-calendar-picker-indicator{cursor:pointer;opacity:0.6;}

  /* Form footer */
  .task-form-footer{display:flex;gap:10px;padding:0 1.5rem 1.5rem;justify-content:flex-end;}

  .btn-cancel-task{
    font-family:'Nunito Sans',sans-serif;font-size:0.82rem;font-weight:700;
    background:transparent;border:1px solid var(--border);color:var(--text-muted);
    padding:10px 20px;border-radius:8px;cursor:pointer;transition:all 0.2s;
  }
  .btn-cancel-task:hover{border-color:var(--auvo-purple);color:var(--auvo-purple);}

  .btn-submit-task{
    font-family:'Nunito Sans',sans-serif;font-weight:800;font-size:0.85rem;
    background:var(--auvo-purple);color:#fff;border:none;
    padding:10px 28px;border-radius:8px;cursor:pointer;
    transition:all 0.2s;display:flex;align-items:center;gap:8px;
    box-shadow:0 4px 12px rgba(111,45,168,0.3);
  }
  .btn-submit-task:hover{background:var(--auvo-purple-dark);box-shadow:0 6px 18px rgba(111,45,168,0.4);}
  .btn-submit-task:disabled{opacity:0.5;cursor:not-allowed;}

  /* Divider */
  .form-divider{height:1px;background:var(--border);margin:1.2rem 0;}

  /* States */
  .state-box{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:5rem 2rem;color:var(--text-muted);text-align:center;gap:1rem;}
  .state-box .icon{font-size:3rem;opacity:0.35;}
  .state-box p{font-size:0.88rem;line-height:1.6;max-width:360px;font-weight:500;}
  .spinner{width:40px;height:40px;border:2px solid var(--border);border-top-color:var(--auvo-purple);border-radius:50%;animation:spin2 0.8s linear infinite;}
  @keyframes spin2{to{transform:rotate(360deg)}}
  .spinner-sm{width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin2 0.7s linear infinite;display:none;}
  .btn-submit-task.loading .spinner-sm{display:block;}
  .btn-submit-task.loading .btn-label{display:none;}

  .error-box{background:var(--red-dim);border:1px solid rgba(229,57,53,0.3);border-radius:10px;padding:1rem 1.2rem;color:var(--red);font-size:0.85rem;font-weight:600;margin-bottom:1rem;display:none;}
  .cors-warning{background:var(--amber-dim);border:1px solid rgba(245,156,0,0.3);border-radius:10px;padding:1rem 1.2rem;color:#b45309;font-size:0.8rem;line-height:1.6;margin-bottom:1.5rem;display:none;font-weight:500;}
  .cors-warning strong{display:block;margin-bottom:4px;font-weight:800;}
  #json-input-section{margin-bottom:1.5rem;display:none;}
  #json-input{width:100%;height:100px;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:'Nunito Sans',sans-serif;font-size:0.82rem;padding:10px;border-radius:8px;outline:none;resize:vertical;}
  #json-input:focus{border-color:var(--auvo-purple);}

  ::-webkit-scrollbar{width:6px;} ::-webkit-scrollbar-track{background:transparent;} ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
  ::-webkit-scrollbar-thumb:hover{background:var(--auvo-purple-light);}

  @media(max-width:900px){
    .header-center{display:none;}
    .stats-bar{grid-template-columns:repeat(2,1fr);}
    .dates-grid,.form-row{grid-template-columns:1fr;}
    .info-grid{grid-template-columns:1fr;}
    .creds-form input{width:120px;}
  }
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-icon">ğŸ«</div>
    AUVO TICKETS
  </div>
  <div class="header-center">
    <div class="refresh-bar" id="refresh-bar" style="display:none;">
      <div class="live-dot" id="live-dot"></div>
      <span class="refresh-label" id="refresh-label">AO VIVO</span>
      <div class="countdown-wrap">
        <svg width="32" height="32" viewBox="0 0 32 32">
          <circle class="countdown-ring-bg" cx="16" cy="16" r="14"/>
          <circle class="countdown-ring" id="countdown-ring" cx="16" cy="16" r="14"/>
        </svg>
        <div class="countdown-num" id="countdown-num">10m</div>
      </div>
      <button class="btn-pause" id="btn-pause" onclick="togglePause()">â¸ PAUSAR</button>
      <span class="last-update" id="last-update"></span>
    </div>
  </div>
  <div class="header-right">
    <button class="btn-load" id="btn-load" onclick="startSession()">â–¶ CARREGAR TICKETS</button>
  </div>
</header>

<main>
  <div class="error-box" id="error-box"></div>
<!-- CORS nÃ£o Ã© problema: backend faz as chamadas -->
  <div class="stats-bar" id="stats-bar">
    <div class="stat-card alta"><div class="stat-label">âš  Prioridade Alta</div><div class="stat-value" id="stat-alta">0</div></div>
    <div class="stat-card media"><div class="stat-label">Prioridade MÃ©dia</div><div class="stat-value" id="stat-media">0</div></div>
    <div class="stat-card baixa"><div class="stat-label">Prioridade Baixa</div><div class="stat-value" id="stat-baixa">0</div></div>
    <div class="stat-card total"><div class="stat-label">Em Aberto</div><div class="stat-value" id="stat-total">0</div></div>
    <div class="stat-card closed"><div class="stat-label">Finalizados (ocultos)</div><div class="stat-value" id="stat-closed">0</div><div class="stat-sub">nÃ£o exibidos no painel</div></div>
  </div>

  <div class="filter-bar" id="filter-bar">
    <button class="filter-btn active-all" onclick="filterTickets('all',this)">Todos abertos</button>
    <button class="filter-btn" onclick="filterTickets('alta',this)">ğŸ”´ Alta</button>
    <button class="filter-btn" onclick="filterTickets('media',this)">ğŸŸ¡ MÃ©dia</button>
    <button class="filter-btn" onclick="filterTickets('baixa',this)">ğŸŸ¢ Baixa</button>
    <button class="filter-btn" onclick="filterTickets('normal',this)">ğŸ”µ Normal</button>
  </div>

  <div id="tickets-container">
    <div class="state-box"><div class="icon">ğŸ«</div><p>Insira suas credenciais e clique em <strong>Carregar</strong> para iniciar o monitoramento.</p></div>
  </div>
</main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL TICKET â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal">
    <div class="modal-header">
      <div class="modal-top">
        <div class="modal-id" id="modal-id"><small>TICKET</small>#â€”</div>
        <button class="modal-close" onclick="closeModalDirect()">âœ•</button>
      </div>
      <div class="modal-title" id="modal-title"></div>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODAL CRIAR TAREFA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="task-modal-overlay" id="task-modal-overlay" onclick="closeTaskModal(event)">
  <div class="task-modal" id="task-modal">

    <div class="task-modal-header">
      <div class="task-modal-top">
        <div class="task-modal-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="9" x2="15" y2="9"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="15" x2="12" y2="15"/></svg>
          CRIAR TAREFA
        </div>
        <button class="modal-close" onclick="closeTaskModalDirect()">âœ•</button>
      </div>
      <div class="task-modal-sub" id="task-modal-sub">Vinculada ao Ticket #â€”</div>
      <div class="origin-badge" id="task-origin-badge">ğŸ« Ticket #â€” â€” sem tÃ­tulo</div>
    </div>

    <div class="task-form" id="task-form">

      <!-- Prioridade herdada (readonly) -->
      <div class="prio-inherited" id="prio-inherited-box">
        <span>Prioridade herdada do ticket:</span>
        <strong id="prio-inherited-label">â€”</strong>
        <span class="prio-lock">ğŸ”’ automÃ¡tico</span>
      </div>

      <!-- TÃ­tulo -->
      <div class="form-group">
        <div class="form-label">TÃ­tulo <span class="req">*</span></div>
        <input class="form-input" id="task-titulo" type="text" placeholder="Ex: Verificar equipamento no local"/>
      </div>

      <!-- Colaborador (idUserTo) -->
      <div class="form-group">
        <div class="form-label">
          Colaborador responsÃ¡vel <span class="req">*</span>
          <span class="lbl-hint" id="users-hint"></span>
        </div>
        <div class="select-loading" id="users-loading-wrap">
          <select class="form-select" id="task-colaborador" disabled>
            <option value="">Carregando colaboradores...</option>
          </select>
        </div>
        <div class="select-error-note" id="users-error">âš  NÃ£o foi possÃ­vel carregar. <a href="#" onclick="loadUsers()" style="color:var(--amber)">Tentar novamente</a></div>
      </div>

      <!-- Tipo de OcorrÃªncia (taskType) -->
      <div class="form-group">
        <div class="form-label">
          Tipo de OcorrÃªncia <span class="req">*</span>
          <span class="lbl-hint" id="types-hint"></span>
        </div>
        <div class="select-loading" id="types-loading-wrap">
          <select class="form-select" id="task-tipo" disabled>
            <option value="">Carregando tipos de tarefa...</option>
          </select>
        </div>
        <div class="select-error-note" id="types-error">âš  NÃ£o foi possÃ­vel carregar. <a href="#" onclick="loadTaskTypes()" style="color:var(--amber)">Tentar novamente</a></div>
      </div>

      <!-- Data agendada -->
      <div class="form-row">
        <div class="form-group" style="margin-bottom:0;">
          <div class="form-label">Data agendada <span class="req">*</span></div>
          <input class="form-input" id="task-data" type="datetime-local"/>
        </div>
        <div class="form-group" style="margin-bottom:0;">
          <div class="form-label">Equipe</div>
          <div class="select-loading" id="teams-loading-wrap" style="display:none;">
            <select class="form-select" id="task-equipe" disabled>
              <option value="">Sem equipe</option>
            </select>
          </div>
          <select class="form-select" id="task-equipe-fallback">
            <option value="">Sem equipe</option>
          </select>
        </div>
      </div>

      <div class="form-divider"></div>

      <!-- DescriÃ§Ã£o -->
      <div class="form-group">
        <div class="form-label">DescriÃ§Ã£o <span class="req">*</span></div>
        <textarea class="form-textarea" id="task-descricao" placeholder="Descreva o que deve ser feito nesta tarefa..."></textarea>
      </div>

      <!-- OrientaÃ§Ã£o (orientation) -->
      <div class="form-group">
        <div class="form-label">OrientaÃ§Ã£o ao colaborador</div>
        <textarea class="form-textarea" id="task-orientacao" placeholder="InstruÃ§Ãµes especÃ­ficas para o tÃ©cnico..." style="min-height:70px;"></textarea>
      </div>

    </div>

    <div class="task-form-footer">
      <button class="btn-cancel-task" onclick="closeTaskModalDirect()">Cancelar</button>
      <button class="btn-submit-task" id="btn-submit-task" onclick="submitTask()">
        <span class="btn-label">âœ“ CRIAR TAREFA</span>
        <div class="spinner-sm"></div>
      </button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” aponta para o backend local/hospedado
// Em produÃ§Ã£o, BASE_API fica vazio (mesmo servidor)
// Em dev local, mude para 'http://localhost:3000'
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BASE_API   = 'https://auvo-tickets-backend-production.up.railway.app';  // URL do backend no Railway
const REFRESH_MS = 10 * 60 * 1000;
const RING_TOTAL = 88;
const CLOSED_STATUS_TYPES = [4, 5];
const CLOSED_STATUS_WORDS = ['encerrado','encerrada','cancelado','cancelada','concluÃ­do','concluida','finalizado','finalizada','closed','done'];

let allTickets    = [];
let closedCount   = 0;
let currentFilter = 'all';
let countdownTimer = null;
let isPaused      = false;
let secondsLeft   = REFRESH_MS / 1000;
let isFirstLoad   = true;
let currentTicket = null;

let cachedUsers     = null;
let cachedTaskTypes = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 1. SESSION â€” sem credenciais no frontend
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startSession() {
  stopTimers(); setLoading(true); hideError();
  try {
    await refreshData(true);
    startAutoRefresh();
    showRefreshBar();
    loadUsers(true);
    loadTaskTypes(true);
  } catch(err) { handleFetchError(err); }
  finally { setLoading(false); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2. FETCH TICKETS via backend
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchAllTickets() {
  const res = await fetch(`${BASE_API}/api/tickets`);
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.error || `Erro ao buscar tickets: ${res.status}`);
  }
  const data = await res.json();
  return data?.result?.entityList || [];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3. FETCH COLLABORATORS via backend (com log de debug)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadUsers(silent = false) {
  if (cachedUsers) { populateUsersSelect(cachedUsers); return; }

  const wrap = document.getElementById('users-loading-wrap');
  const sel  = document.getElementById('task-colaborador');
  const err  = document.getElementById('users-error');
  const hint = document.getElementById('users-hint');

  wrap.classList.add('select-loading');
  err.style.display = 'none';
  sel.disabled = true;

  try {
    console.log('[Frontend] Buscando colaboradores em /api/collaborators');
    const res  = await fetch(`${BASE_API}/api/collaborators`);
    const data = await res.json();

    console.log('[Frontend] Resposta colaboradores:', JSON.stringify(data).slice(0, 500));

    if (!res.ok) throw new Error(data.error || `Erro ${res.status}`);

    const list = data?.result?.entityList || [];
    if (list.length === 0) throw new Error('Nenhum colaborador retornado. Veja os logs do servidor.');

    console.log('[Frontend] Exemplo colaborador:', JSON.stringify(list[0]));
    cachedUsers = list.filter(u => u.active !== false && !u.unavailableForTasks);
    if (cachedUsers.length === 0) cachedUsers = list;

    populateUsersSelect(cachedUsers);
    if (!silent) hint.textContent = `${cachedUsers.length} colaboradores`;
    console.log(`[Frontend] âœ“ ${cachedUsers.length} colaboradores carregados`);

  } catch(e) {
    console.error('[Frontend] Falha colaboradores:', e.message);
    sel.innerHTML = `<option value="">âš  ${e.message}</option>`;
    sel.disabled = false;
    err.style.display = 'block';
  } finally {
    wrap.classList.remove('select-loading');
  }
}

function populateUsersSelect(users) {
  const sel  = document.getElementById('task-colaborador');
  const hint = document.getElementById('users-hint');
  sel.innerHTML = '<option value="">Selecione um colaborador</option>';
  const sorted = [...users].sort((a, b) => (a.name || '').localeCompare(b.name || '', 'pt-BR'));
  sorted.forEach(u => {
    const opt   = document.createElement('option');
    opt.value   = u.userId || u.collaboratorId || u.id || '';
    const cargo = u.jobPosition ? ` (${u.jobPosition})` : '';
    opt.textContent = (u.name || `Colaborador #${opt.value}`) + cargo;
    sel.appendChild(opt); // insere mesmo sem value para debug
  });
  sel.disabled = false;
  hint.textContent = `${users.length} colaboradores`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4. FETCH TASK TYPES via backend (com log de debug)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadTaskTypes(silent = false) {
  if (cachedTaskTypes) { populateTaskTypesSelect(cachedTaskTypes); return; }

  const wrap = document.getElementById('types-loading-wrap');
  const sel  = document.getElementById('task-tipo');
  const err  = document.getElementById('types-error');
  const hint = document.getElementById('types-hint');

  wrap.classList.add('select-loading');
  err.style.display = 'none';
  sel.disabled = true;

  try {
    console.log('[Frontend] Buscando tipos em /api/task-types');
    const res  = await fetch(`${BASE_API}/api/task-types`);
    const data = await res.json();

    console.log('[Frontend] Resposta tipos:', JSON.stringify(data).slice(0, 500));

    if (!res.ok) throw new Error(data.error || `Erro ${res.status}`);

    const list = data?.result?.entityList || [];
    if (list.length === 0) throw new Error('Nenhum tipo retornado. Veja os logs do servidor.');

    cachedTaskTypes = list;
    populateTaskTypesSelect(cachedTaskTypes);
    if (!silent) hint.textContent = `${cachedTaskTypes.length} tipos`;
    console.log(`[Frontend] âœ“ ${cachedTaskTypes.length} tipos carregados`);

  } catch(e) {
    console.error('[Frontend] Falha tipos:', e.message);
    sel.innerHTML = `<option value="">âš  ${e.message}</option>`;
    sel.disabled = false;
    err.style.display = 'block';
  } finally {
    wrap.classList.remove('select-loading');
  }
}

function populateTaskTypesSelect(types) {
  const sel  = document.getElementById('task-tipo');
  const hint = document.getElementById('types-hint');
  sel.innerHTML = '<option value="">Selecione o tipo de ocorrÃªncia</option>';
  const sorted = [...types].sort((a, b) =>
    (a.taskTypeDescription || a.description || a.name || '').localeCompare(b.taskTypeDescription || b.description || b.name || '', 'pt-BR')
  );
  sorted.forEach(tp => {
    const opt = document.createElement('option');
    opt.value = tp.taskTypeId || tp.id || tp.taskTypeID || '';
    opt.textContent = tp.taskTypeDescription || tp.description || tp.name || `Tipo #${opt.value}`;
    sel.appendChild(opt); // insere mesmo sem value para debug
  });
  sel.disabled = false;
  hint.textContent = `${types.length} tipos`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5. REFRESH AUTOMÃTICO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isFinished(t) {
  if (CLOSED_STATUS_TYPES.includes(t.statusType)) return true;
  const d = (t.statusDescription||'').toLowerCase().normalize('NFD').replace(/[Ì€-Í¯]/g,'');
  return CLOSED_STATUS_WORDS.some(w=>d.includes(w));
}

async function refreshData(isInitial=false) {
  setSyncingDot(true);
  try {
    const all    = await fetchAllTickets();
    const open   = all.filter(t=>!isFinished(t));
    const closed = all.filter(t=>isFinished(t));
    if (!isInitial && allTickets.length>0) detectChanges(allTickets, open);
    allTickets = open; closedCount = closed.length; isFirstLoad = false;
    renderAll(open, closed.length); updateLastUpdate();
  } catch(err) {
    console.error(err);
    showToast('âš  Falha ao atualizar. Tentando em 10 min.', 'error');
  } finally { setSyncingDot(false); }
}

function detectChanges(prev, next) {
  const prevIds = new Set(prev.map(t=>t.id));
  const nextIds = new Set(next.map(t=>t.id));
  const finished = prev.filter(t=>!nextIds.has(t.id));
  const added    = next.filter(t=>!prevIds.has(t.id));
  if (finished.length) {
    finished.forEach(t=>{ const c=document.querySelector(`[data-ticket-id="${t.id}"]`); if(c){c.classList.add('removing');setTimeout(()=>c.remove(),500);} });
    showToast(`âœ“ ${finished.length} ticket(s) finalizado(s) e removido(s)`);
  }
  if (added.length) showToast(`+ ${added.length} novo(s) ticket(s) aberto(s)`, 'info');
}

function startAutoRefresh() {
  stopTimers(); secondsLeft = REFRESH_MS/1000; updateCountdownUI();
  countdownTimer = setInterval(()=>{
    if (isPaused) return;
    secondsLeft--;
    updateCountdownUI();
    if (secondsLeft<=0) { secondsLeft=REFRESH_MS/1000; refreshData(false); }
  }, 1000);
}
function stopTimers() { clearInterval(countdownTimer); }
function togglePause() {
  isPaused=!isPaused;
  const btn=document.getElementById('btn-pause'), dot=document.getElementById('live-dot'), lbl=document.getElementById('refresh-label');
  if(isPaused){btn.textContent='â–¶ RETOMAR';dot.classList.add('paused');lbl.textContent='PAUSADO';}
  else{btn.textContent='â¸ PAUSAR';dot.classList.remove('paused');lbl.textContent='AO VIVO';secondsLeft=REFRESH_MS/1000;}
}
function updateCountdownUI() {
  const ring=document.getElementById('countdown-ring'), num=document.getElementById('countdown-num');
  const pct=secondsLeft/(REFRESH_MS/1000), offset=RING_TOTAL-(RING_TOTAL*pct);
  ring.style.strokeDashoffset=offset;
  ring.classList.toggle('urgent', secondsLeft<=60);
  num.textContent = secondsLeft<=60 ? secondsLeft+'s' : Math.ceil(secondsLeft/60)+'m';
}
function setSyncingDot(on) {
  const dot=document.getElementById('live-dot'), lbl=document.getElementById('refresh-label');
  if(on){dot.classList.add('syncing');lbl.textContent='SINCRONIZANDO...';}
  else{dot.classList.remove('syncing');dot.className='live-dot'+(isPaused?' paused':'');lbl.textContent=isPaused?'PAUSADO':'AO VIVO';}
}
function updateLastUpdate() { document.getElementById('last-update').textContent=`atualizado Ã s ${new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}`; }
function showRefreshBar() { document.getElementById('refresh-bar').style.display='flex'; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 6. RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(open, closedQty) { updateStats(open,closedQty); showStats(); applyCurrentFilter(); }

function updateStats(tickets, closedQty) {
  const c=p=>tickets.filter(t=>normPrio(t.priority)===p).length;
  const s=(id,val)=>{const el=document.getElementById(id);if(el)el.textContent=val;};
  s('stat-alta',c('alta')); s('stat-media',c('media')); s('stat-baixa',c('baixa'));
  s('stat-total',tickets.length); s('stat-closed',closedQty);
  const note=document.getElementById('status-note');
  const noteText=document.getElementById('status-note-text');
  if(noteText) noteText.textContent='Exibindo '+tickets.length+' ticket(s) em aberto. '+closedQty+' finalizado(s) ocultos.';
  if(note) note.style.display='flex';
}
function showStats() { document.getElementById('stats-bar').classList.add('visible'); document.getElementById('filter-bar').classList.add('visible'); }

function applyCurrentFilter() {
  const filtered=currentFilter==='all'?allTickets:allTickets.filter(t=>normPrio(t.priority)===currentFilter);
  renderTickets(filtered);
}

function normPrio(p) {
  if(!p) return 'normal';
  const v=p.toString().toLowerCase().normalize('NFD').replace(/[Ì€-Í¯]/g,'');
  if(v.includes('alta')||v==='high') return 'alta';
  if(v.includes('media')||v==='medium') return 'media';
  if(v.includes('baixa')||v==='low') return 'baixa';
  return 'normal';
}
function prioLabel(p) { return {alta:'Alta',media:'MÃ©dia',baixa:'Baixa',normal:'Normal'}[normPrio(p)]||p; }
function fmtDate(ds) { if(!ds)return'â€”'; try{return new Date(ds).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'});}catch{return ds;} }
function initials(n) { if(!n)return'?'; return n.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase(); }
function calcDaysOpen(s,e) { try{return Math.round(((e?new Date(e):new Date())-new Date(s))/86400000);}catch{return'â€”';} }

function renderTickets(tickets) {
  const container=document.getElementById('tickets-container');
  if(!tickets.length){ container.innerHTML=`<div class="state-box"><div class="icon">âœ…</div><p>Nenhum ticket aberto para este filtro.</p></div>`; return; }
  const sorted=[...tickets].sort((a,b)=>{const o={alta:0,media:1,baixa:2,normal:3};return(o[normPrio(a.priority)]??4)-(o[normPrio(b.priority)]??4);});
  container.innerHTML=`<div class="tickets-grid" id="tickets-grid"></div>`;
  const grid=document.getElementById('tickets-grid');
  sorted.forEach((t,i)=>{
    const prio=normPrio(t.priority);
    const card=document.createElement('div');
    card.className=`ticket-card prio-${prio}`;
    card.dataset.ticketId=t.id;
    card.style.animationDelay=`${i*0.04}s`;
    card.onclick=()=>openModal(t);
    card.innerHTML=`
      ${prio==='alta'?`<div class="alert-banner"><span class="blink"></span>ATENÃ‡ÃƒO â€” PRIORIDADE ALTA</div>`:''}
      <div class="card-header">
        <div class="ticket-id"><span>TICKET</span>#${t.id}</div>
        <span class="prio-badge ${prio}">${prioLabel(t.priority)}</span>
      </div>
      <div class="ticket-title">${t.title||'Sem tÃ­tulo'}</div>
      <div class="assignee-row">
        <div class="avatar">${initials(t.userResponsableName)}</div>
        <div class="assignee-info">
          <div class="assignee-name">${t.userResponsableName||'â€”'}</div>
          <div class="assignee-label">RESPONSÃVEL</div>
        </div>
      </div>
      <div class="card-footer">
        <span class="status-chip">${t.statusDescription||'â€”'}</span>
        <span class="card-date">${fmtDate(t.creationDate)}</span>
        <span class="expand-hint">ver detalhes â†’</span>
      </div>`;
    grid.appendChild(card);
  });
}

function filterTickets(filter,btn) {
  currentFilter=filter;
  document.querySelectorAll('.filter-btn').forEach(b=>b.className='filter-btn');
  btn.classList.add(`active-${filter}`);
  applyCurrentFilter();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 7. MODAL TICKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(t) {
  currentTicket = t;
  const prio=normPrio(t.priority);
  document.getElementById('modal').className=`modal prio-${prio}`;
  document.getElementById('modal-id').innerHTML=`<small>TICKET</small>#${t.id}`;
  document.getElementById('modal-title').textContent=t.title||'Sem tÃ­tulo';

  document.getElementById('modal-body').innerHTML=`
    ${prio==='alta'?`<div class="modal-alert"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Este ticket Ã© de <strong>PRIORIDADE ALTA</strong> e requer atenÃ§Ã£o imediata.</div>`:''}
    <div class="modal-section">
      <div class="section-label">InformaÃ§Ãµes Gerais</div>
      <div class="info-grid">
        <div class="info-item"><div class="info-key">PRIORIDADE</div><div class="info-val highlight ${prio}">${prioLabel(t.priority)}</div></div>
        <div class="info-item"><div class="info-key">STATUS</div><div class="info-val highlight">${t.statusDescription||'â€”'}</div></div>
        <div class="info-item"><div class="info-key">TIPO DE SOLICITAÃ‡ÃƒO</div><div class="info-val">${t.requestTypeDescription||'â€”'}</div></div>
        <div class="info-item"><div class="info-key">CLIENTE</div><div class="info-val">${t.customerName||'â€”'}</div></div>
        <div class="info-item"><div class="info-key">RESPONSÃVEL</div><div class="info-val">${t.userResponsableName||'â€”'}</div></div>
        <div class="info-item"><div class="info-key">CRIADO POR</div><div class="info-val">${t.userCreatorName||'â€”'}</div></div>
        ${t.teamName?`<div class="info-item"><div class="info-key">EQUIPE</div><div class="info-val">${t.teamName}</div></div>`:''}
        ${t.taskIDs?.length?`<div class="info-item"><div class="info-key">TASKS VINCULADAS</div><div class="info-val">${t.taskIDs.join(', ')}</div></div>`:''}
      </div>
    </div>
    <div class="modal-section">
      <div class="section-label">ğŸ“… Datas</div>
      <div class="dates-grid">
        <div class="date-card"><div class="date-icon">ğŸ“</div><div class="date-label">CriaÃ§Ã£o</div><div class="date-value">${fmtDate(t.creationDate)}</div><div class="date-time">${t.creationDate?new Date(t.creationDate).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):''}</div></div>
        <div class="date-card"><div class="date-icon">ğŸ“…</div><div class="date-label">Encerramento Prev.</div><div class="date-value">${fmtDate(t.endDate)}</div><div class="date-time">${t.endDate?new Date(t.endDate).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}):'â€”'}</div></div>
        <div class="date-card"><div class="date-icon">â±</div><div class="date-label">Tempo em Aberto</div><div class="date-value">${calcDaysOpen(t.creationDate,null)}</div><div class="date-time">dias</div></div>
      </div>
    </div>
    ${(t.requesterName||t.requesterEmail||t.customerEmail||t.customerPhoneNumber)?`
    <div class="modal-section">
      <div class="section-label">Contato</div>
      <div class="info-grid">
        ${t.requesterName?`<div class="info-item"><div class="info-key">SOLICITANTE</div><div class="info-val">${t.requesterName}</div></div>`:''}
        ${t.requesterEmail?`<div class="info-item"><div class="info-key">E-MAIL SOLICITANTE</div><div class="info-val">${t.requesterEmail}</div></div>`:''}
        ${t.customerEmail?`<div class="info-item"><div class="info-key">E-MAIL CLIENTE</div><div class="info-val">${t.customerEmail}</div></div>`:''}
        ${t.customerPhoneNumber?`<div class="info-item"><div class="info-key">TELEFONE</div><div class="info-val">${t.customerPhoneNumber}</div></div>`:''}
      </div>
    </div>`:''}
    ${t.description?`<div class="modal-section"><div class="section-label">DescriÃ§Ã£o</div><div class="desc-box">${t.description}</div></div>`:''}
    ${t.customFields?.length?`
    <div class="modal-section">
      <div class="section-label">Campos Personalizados</div>
      <div class="info-grid">${t.customFields.map(cf=>`<div class="info-item"><div class="info-key">${cf.customFieldTicket?.title||'Campo'}</div><div class="info-val">${cf.valueDescription||cf.value||'â€”'}</div></div>`).join('')}</div>
    </div>`:''}
    <div class="modal-section">
      <div class="section-label">AÃ§Ãµes</div>
      <button class="btn-create-task" onclick="openTaskModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
        CRIAR TAREFA A PARTIR DESTE TICKET
      </button>
    </div>
  `;

  document.getElementById('modal-overlay').classList.add('open');
  document.body.style.overflow='hidden';
}

function closeModal(e) { if(e.target===document.getElementById('modal-overlay')) closeModalDirect(); }
function closeModalDirect() { document.getElementById('modal-overlay').classList.remove('open'); document.body.style.overflow=''; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 8. MODAL CRIAR TAREFA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTaskModal() {
  if (!currentTicket) return;
  const t    = currentTicket;
  const prio = normPrio(t.priority);

  document.getElementById('task-modal-sub').textContent      = `Vinculada ao Ticket #${t.id}`;
  document.getElementById('task-origin-badge').textContent   = `ğŸ« Ticket #${t.id} â€” ${t.title||'Sem tÃ­tulo'}`;
  document.getElementById('task-titulo').value               = t.title||'';
  document.getElementById('task-descricao').value            = t.description||'';

  const suggested = new Date(); suggested.setHours(suggested.getHours()+1);
  document.getElementById('task-data').value = suggested.toISOString().slice(0,16);

  const priBox = document.getElementById('prio-inherited-box');
  priBox.className = `prio-inherited prio-${prio}`;
  document.getElementById('prio-inherited-label').textContent = prioLabel(t.priority);

  loadUsers();
  loadTaskTypes();

  document.getElementById('task-modal-overlay').classList.add('open');
}

function closeTaskModal(e) { if(e.target===document.getElementById('task-modal-overlay')) closeTaskModalDirect(); }
function closeTaskModalDirect() { document.getElementById('task-modal-overlay').classList.remove('open'); }
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeTaskModalDirect(); closeModalDirect(); } });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 9. SUBMIT TAREFA via backend
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitTask() {
  const t = currentTicket;
  if (!t) return;

  const titulo      = document.getElementById('task-titulo').value.trim();
  const colaborador = document.getElementById('task-colaborador').value;
  const tipo        = document.getElementById('task-tipo').value;
  const data        = document.getElementById('task-data').value;
  const descricao   = document.getElementById('task-descricao').value.trim();
  const orientacao  = document.getElementById('task-orientacao').value.trim();

  if (!titulo)      { showToast('âš  Preencha o TÃ­tulo da tarefa.', 'error'); return; }
  if (!colaborador) { showToast('âš  Selecione o Colaborador.', 'error'); return; }
  if (!tipo)        { showToast('âš  Selecione o Tipo de OcorrÃªncia.', 'error'); return; }
  if (!data)        { showToast('âš  Informe a Data agendada.', 'error'); return; }
  if (!descricao)   { showToast('âš  Preencha a DescriÃ§Ã£o.', 'error'); return; }

  const prioMap    = { alta:'4', media:'3', baixa:'2', normal:'1' };
  const prioValue  = prioMap[normPrio(t.priority)] || '1';
  const taskDateFmt = new Date(data).toISOString().slice(0, 19);

  const orientacaoParts = [];
  if (titulo)     orientacaoParts.push(titulo);
  if (descricao)  orientacaoParts.push(descricao);
  if (orientacao) orientacaoParts.push('OrientaÃ§Ã£o: ' + orientacao);

  const payload = {
    idUserTo:    parseInt(colaborador),
    taskType:    parseInt(tipo),
    taskDate:    taskDateFmt,
    orientation: orientacaoParts.join('\n\n'),
    priority:    prioValue,
    ticketId:    t.id,
  };
  if (t.customerId) payload.customerId = parseInt(t.customerId);

  const btn = document.getElementById('btn-submit-task');
  btn.disabled = true;
  btn.classList.add('loading');

  try {
    const res  = await fetch(`${BASE_API}/api/tasks`, {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify(payload)
    });
    const result = await res.json();

    if (!res.ok) throw new Error(result.error || `Erro ${res.status}`);

    const taskId = result?.result?.taskID || result?.result?.id || result?.taskID || 'â€”';
    showToast(`âœ“ Tarefa #${taskId} criada com sucesso!`);
    closeTaskModalDirect();
    if (!t.taskIDs) t.taskIDs = [];
    if (taskId !== 'â€”') t.taskIDs.push(parseInt(taskId));

  } catch(err) {
    console.error('[Frontend] Erro ao criar tarefa:', err);
    showToast('âŒ ' + err.message, 'error');
  } finally {
    btn.disabled = false;
    btn.classList.remove('loading');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 10. HELPERS UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimeout;
function showToast(msg, type='success') {
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.className=`toast show${type==='error'?' error':type==='info'?' info':''}`;
  clearTimeout(toastTimeout);
  toastTimeout=setTimeout(()=>el.classList.remove('show'),4500);
}
function setLoading(on) {
  const btn=document.getElementById('btn-load');
  btn.disabled=on; btn.textContent=on?'â³ Carregando...':'â–¶ CARREGAR TICKETS';
  if(on) document.getElementById('tickets-container').innerHTML=`<div class="state-box"><div class="spinner"></div><p>Buscando tickets na API do Auvo...</p></div>`;
}
function showError(msg){const b=document.getElementById('error-box');b.textContent='âŒ '+msg;b.style.display='block';}
function hideError(){const e=document.getElementById('error-box');if(e)e.style.display='none';const c=document.getElementById('cors-warning');if(c)c.style.display='none';}
function handleFetchError(err){
  console.error(err);
  showError(err.message);
}

// â”€â”€ Carrega automaticamente ao abrir a pÃ¡gina
window.onload = () => startSession();
</script>
</body>
</html>
